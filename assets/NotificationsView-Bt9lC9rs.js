import{a as O,r as v,c as f,l as P,Y,p as G,w as J,u as K,o as c,h as a,b as d,e as x,t as i,k as $,n as p,F as Q,s as W,O as X}from"./vue-vendor-DJ0JNZJp.js";import{s as g,u as Z,c as ee,a as te}from"./index-BBvWYsGI.js";import{_ as se}from"./MainLayout.vue_vue_type_script_setup_true_lang-Ds5fRedJ.js";import"./supabase-aQ0K3vAX.js";import"./logofmd-DeXnOIzE.js";const _={async fetch(l){const{data:r,error:n}=await g.from("notifications").select("*").eq("user_id",l).order("created_at",{ascending:!1});if(n)throw n;return r||[]},async markAsRead(l){const{data:r,error:n}=await g.from("notifications").update({read:!0}).eq("id",l).select().single();if(n)throw n;return r},async markAllAsRead(l){const{error:r}=await g.from("notifications").update({read:!0}).eq("user_id",l).eq("read",!1);if(r)throw r;return!0},subscribeToUser(l,r){const n=g.channel(`notifications:${l}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${l}`},o=>{r(o.new)}).subscribe();return()=>{g.removeChannel(n)}}},ae={class:"px-4 py-6 space-y-6"},re={class:"flex items-center justify-between"},ne={class:"text-2xl font-bold text-gray-900 dark:text-dark-text"},oe=["disabled"],ie={class:"flex rounded-full bg-gray-100 dark:bg-dark-card p-1"},le={key:0,class:"ml-2 px-2 py-0.5 text-xs bg-primary text-white rounded-full"},ce={key:0,class:"ml-2 px-2 py-0.5 text-xs bg-primary text-white rounded-full"},ue={key:0,class:"text-center py-12 card"},de={class:"text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2"},fe={class:"text-gray-500 dark:text-gray-400"},me={key:1,class:"space-y-3"},ye=["onClick"],he={class:"flex items-start space-x-3"},pe={class:"flex-1 min-w-0"},ge={class:"font-semibold text-gray-900 dark:text-dark-text mb-1"},be={class:"text-sm text-gray-600 dark:text-gray-400 mb-2"},ve={class:"text-xs text-gray-500"},xe=["onClick"],$e=O({__name:"NotificationsView",setup(l){const r=K(),n=Z(),{t:o}=ee(),{error:k}=te(),m=v("all"),u=v([]),R=v(!1),y=v(!1);let h=null;const q=f(()=>u.value),I=f(()=>u.value.filter(e=>e.type==="message")),N=f(()=>m.value==="all"?q.value:I.value),w=f(()=>u.value.filter(e=>!e.read).length),T=f(()=>I.value.filter(e=>!e.read).length),M=f(()=>m.value==="chats"?{title:o("notifications.emptyChats"),subtitle:o("notifications.emptyChatsSubtitle")}:{title:o("notifications.empty"),subtitle:o("notifications.emptySubtitle")}),B=e=>e?"opacity-60":"bg-primary/5",S=e=>{const t="flex-1 py-2 rounded-full text-sm font-semibold transition-colors";return m.value===e?`${t} bg-white dark:bg-dark-bg text-primary shadow`:`${t} text-gray-500`},D=e=>{const t={document_match:"w-10 h-10 rounded-full bg-success/10 text-success flex items-center justify-center",document_found:"w-10 h-10 rounded-full bg-success/10 text-success flex items-center justify-center",message:"w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center",system:"w-10 h-10 rounded-full bg-gray-100 dark:bg-dark-card text-gray-600 dark:text-gray-400 flex items-center justify-center",verification:"w-10 h-10 rounded-full bg-warning/10 text-warning-dark flex items-center justify-center"};return t[e]||t.system},L=e=>({document_match:"fas fa-check-double",document_found:"fas fa-search",message:"fas fa-envelope",system:"fas fa-info-circle",verification:"fas fa-shield-alt"})[e]||"fas fa-bell",V=e=>{const t=new Date,s=new Date(e),C=t.getTime()-s.getTime(),b=Math.floor(C/6e4),A=Math.floor(b/60),j=Math.floor(A/24);return b<1?o("notifications.timeAgo.now"):b<60?o("notifications.timeAgo.minutes",{n:b}):A<24?o("notifications.timeAgo.hours",{n:A}):j<7?o("notifications.timeAgo.days",{n:j}):s.toLocaleDateString("pt-BR",{day:"2-digit",month:"short"})},U=async()=>{if(!n.userId){r.push({name:"Login",query:{redirect:r.currentRoute.value.fullPath}});return}R.value=!0;try{u.value=await _.fetch(n.userId)}catch(e){k(e.message||o("notifications.loadingError"))}finally{R.value=!1}},F=()=>{!n.userId||h||(h=_.subscribeToUser(n.userId,e=>{u.value=[e,...u.value]}))},z=async e=>{await E(e.id),e.data&&((e.type==="document_match"||e.type==="document_found")&&"documentId"in e.data?r.push(`/document/${e.data.documentId}`):e.type==="message"&&"document_id"in e.data?r.push(`/chat/${e.data.document_id}`):e.type==="verification"&&"documentId"in e.data&&r.push(`/document/${e.data.documentId}`))},E=async e=>{const t=u.value.find(s=>s.id===e);if(!(!t||t.read)){t.read=!0;try{await _.markAsRead(e)}catch(s){k(s.message||o("notifications.updateError")),t.read=!1}}},H=async()=>{if(!(!n.userId||y.value)){y.value=!0;try{await _.markAllAsRead(n.userId),u.value.forEach(e=>e.read=!0)}catch(e){k(e.message||o("notifications.markAllError"))}finally{y.value=!1}}};return P(async()=>{await U(),F()}),Y(()=>{h&&(h(),h=null)}),(e,t)=>(c(),G(se,null,{default:J(()=>[a("div",ae,[a("div",re,[a("h1",ne,i(e.$t("notifications.title")),1),w.value>0?(c(),d("button",{key:0,onClick:H,class:"text-sm text-primary hover:text-primary-dark font-medium transition-colors",disabled:y.value},[t[2]||(t[2]=a("i",{class:"fas fa-check-double mr-1"},null,-1)),$(" "+i(y.value?e.$t("notifications.marking"):e.$t("notifications.markAllRead")),1)],8,oe)):x("",!0)]),a("div",ie,[a("button",{class:p(S("all")),onClick:t[0]||(t[0]=s=>m.value="all")},[$(i(e.$t("notifications.tabs.all"))+" ",1),w.value>0?(c(),d("span",le,i(w.value),1)):x("",!0)],2),a("button",{class:p(S("chats")),onClick:t[1]||(t[1]=s=>m.value="chats")},[$(i(e.$t("notifications.tabs.chats"))+" ",1),T.value>0?(c(),d("span",ce,i(T.value),1)):x("",!0)],2)]),N.value.length===0?(c(),d("div",ue,[t[3]||(t[3]=a("i",{class:"fas fa-bell-slash text-gray-400 text-6xl mb-4"},null,-1)),a("h3",de,i(M.value.title),1),a("p",fe,i(M.value.subtitle),1)])):(c(),d("div",me,[(c(!0),d(Q,null,W(N.value,s=>(c(),d("div",{key:s.id,class:p([B(s.read),"card card-hover"]),onClick:C=>z(s)},[a("div",he,[a("div",{class:p(D(s.type))},[a("i",{class:p(L(s.type))},null,2)],2),a("div",pe,[a("h4",ge,i(s.title),1),a("p",be,i(s.message),1),a("p",ve,i(V(s.created_at)),1)]),s.read?x("",!0):(c(),d("button",{key:0,class:"w-2 h-2 rounded-full bg-primary",onClick:X(C=>E(s.id),["stop"])},null,8,xe))])],10,ye))),128))]))])]),_:1}))}});export{$e as default};
