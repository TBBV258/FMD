import{a as H,r as v,c as m,l as P,Y,p as G,w as J,u as K,o as c,h as n,b as f,e as x,t as l,k as $,n as p,F as Q,s as W,O as X}from"./vue-vendor-DJ0JNZJp.js";import{s as g,u as Z,c as ee,a as te}from"./index-DomtK_OL.js";import{_ as ae}from"./MainLayout.vue_vue_type_script_setup_true_lang-s1TSJ6UG.js";import"./supabase-aQ0K3vAX.js";import"./logofmd-DeXnOIzE.js";const k={async fetch(d){const{data:s,error:o}=await g.from("notifications").select("*").eq("user_id",d).order("created_at",{ascending:!1});if(o)throw o;return(s||[]).map(a=>({...a,read:a.read||a.is_read||!1,is_read:a.is_read||a.read||!1,data:a.data||a.metadata||null,metadata:a.metadata||a.data||null}))},async markAsRead(d){const{data:s,error:o}=await g.from("notifications").update({read:!0,is_read:!0,read_at:new Date().toISOString()}).eq("id",d).select().single();if(o)throw o;return{...s,read:!0,is_read:!0,data:s.metadata||s.data||null,metadata:s.metadata||s.data||null}},async markAllAsRead(d){const{error:s}=await g.from("notifications").update({read:!0,is_read:!0,read_at:new Date().toISOString()}).eq("user_id",d).or("read.eq.false,is_read.eq.false");if(s)throw s;return!0},subscribeToUser(d,s){const o=g.channel(`notifications:${d}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${d}`},a=>{const i=a.new;s({...i,read:i.read||i.is_read||!1,is_read:i.is_read||i.read||!1,data:i.data||i.metadata||null,metadata:i.metadata||i.data||null})}).subscribe();return()=>{g.removeChannel(o)}}},se={class:"px-4 py-6 space-y-6"},re={class:"flex items-center justify-between"},ne={class:"text-2xl font-bold text-gray-900 dark:text-dark-text"},oe=["disabled"],ie={class:"flex rounded-full bg-gray-100 dark:bg-dark-card p-1"},le={key:0,class:"ml-2 px-2 py-0.5 text-xs bg-primary text-white rounded-full"},de={key:0,class:"ml-2 px-2 py-0.5 text-xs bg-primary text-white rounded-full"},ce={key:0,class:"text-center py-12 card"},ue={class:"text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2"},fe={class:"text-gray-500 dark:text-gray-400"},me={key:1,class:"space-y-3"},he=["onClick"],ye={class:"flex items-start space-x-3"},_e={class:"flex-1 min-w-0"},pe={class:"font-semibold text-gray-900 dark:text-dark-text mb-1"},ge={class:"text-sm text-gray-600 dark:text-gray-400 mb-2"},be={class:"text-xs text-gray-500"},ve=["onClick"],$e=H({__name:"NotificationsView",setup(d){const s=K(),o=Z(),{t:a}=ee(),{error:i}=te(),h=v("all"),u=v([]),I=v(!1),y=v(!1);let _=null;const E=m(()=>u.value),R=m(()=>u.value.filter(e=>e.type==="message")),S=m(()=>h.value==="all"?E.value:R.value),w=m(()=>u.value.filter(e=>!e.read&&!e.is_read).length),N=m(()=>R.value.filter(e=>!e.read&&!e.is_read).length),T=m(()=>h.value==="chats"?{title:a("notifications.emptyChats"),subtitle:a("notifications.emptyChatsSubtitle")}:{title:a("notifications.empty"),subtitle:a("notifications.emptySubtitle")}),j=e=>e.read||e.is_read?"opacity-60":"bg-primary/5",M=e=>{const t="flex-1 py-2 rounded-full text-sm font-semibold transition-colors";return h.value===e?`${t} bg-white dark:bg-dark-bg text-primary shadow`:`${t} text-gray-500`},B=e=>{const t={document_match:"w-10 h-10 rounded-full bg-success/10 text-success flex items-center justify-center",document_found:"w-10 h-10 rounded-full bg-success/10 text-success flex items-center justify-center",message:"w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center",system:"w-10 h-10 rounded-full bg-gray-100 dark:bg-dark-card text-gray-600 dark:text-gray-400 flex items-center justify-center",verification:"w-10 h-10 rounded-full bg-warning/10 text-warning-dark flex items-center justify-center"};return t[e]||t.system},L=e=>({document_match:"fas fa-check-double",document_found:"fas fa-search",message:"fas fa-envelope",system:"fas fa-info-circle",verification:"fas fa-shield-alt"})[e]||"fas fa-bell",V=e=>{const t=new Date,r=new Date(e),C=t.getTime()-r.getTime(),b=Math.floor(C/6e4),A=Math.floor(b/60),D=Math.floor(A/24);return b<1?a("notifications.timeAgo.now"):b<60?a("notifications.timeAgo.minutes",{n:b}):A<24?a("notifications.timeAgo.hours",{n:A}):D<7?a("notifications.timeAgo.days",{n:D}):r.toLocaleDateString("pt-BR",{day:"2-digit",month:"short"})},O=async()=>{if(!o.userId){s.push({name:"Login",query:{redirect:s.currentRoute.value.fullPath}});return}I.value=!0;try{u.value=await k.fetch(o.userId)}catch(e){i(e.message||a("notifications.loadingError"))}finally{I.value=!1}},U=()=>{!o.userId||_||(_=k.subscribeToUser(o.userId,e=>{u.value=[e,...u.value]}))},F=async e=>{if(await q(e.id),e.action_url){s.push(e.action_url);return}const t=e.metadata||e.data;t&&((e.type==="document_match"||e.type==="document_found")&&"documentId"in t?s.push(`/document/${t.documentId}`):e.type==="message"&&"document_id"in t?s.push(`/chat/${t.document_id}`):e.type==="verification"&&"documentId"in t?s.push(`/document/${t.documentId}`):e.type==="document_status_change"&&"documentId"in t&&s.push(`/document/${t.documentId}`))},q=async e=>{const t=u.value.find(r=>r.id===e);if(!(!t||t.read||t.is_read)){t.read=!0,t.is_read=!0;try{await k.markAsRead(e)}catch(r){i(r.message||a("notifications.updateError")),t.read=!1,t.is_read=!1}}},z=async()=>{if(!(!o.userId||y.value)){y.value=!0;try{await k.markAllAsRead(o.userId),u.value.forEach(e=>{e.read=!0,e.is_read=!0})}catch(e){i(e.message||a("notifications.markAllError"))}finally{y.value=!1}}};return P(async()=>{await O(),U()}),Y(()=>{_&&(_(),_=null)}),(e,t)=>(c(),G(ae,null,{default:J(()=>[n("div",se,[n("div",re,[n("h1",ne,l(e.$t("notifications.title")),1),w.value>0?(c(),f("button",{key:0,onClick:z,class:"text-sm text-primary hover:text-primary-dark font-medium transition-colors",disabled:y.value},[t[2]||(t[2]=n("i",{class:"fas fa-check-double mr-1"},null,-1)),$(" "+l(y.value?e.$t("notifications.marking"):e.$t("notifications.markAllRead")),1)],8,oe)):x("",!0)]),n("div",ie,[n("button",{class:p(M("all")),onClick:t[0]||(t[0]=r=>h.value="all")},[$(l(e.$t("notifications.tabs.all"))+" ",1),w.value>0?(c(),f("span",le,l(w.value),1)):x("",!0)],2),n("button",{class:p(M("chats")),onClick:t[1]||(t[1]=r=>h.value="chats")},[$(l(e.$t("notifications.tabs.chats"))+" ",1),N.value>0?(c(),f("span",de,l(N.value),1)):x("",!0)],2)]),S.value.length===0?(c(),f("div",ce,[t[3]||(t[3]=n("i",{class:"fas fa-bell-slash text-gray-400 text-6xl mb-4"},null,-1)),n("h3",ue,l(T.value.title),1),n("p",fe,l(T.value.subtitle),1)])):(c(),f("div",me,[(c(!0),f(Q,null,W(S.value,r=>(c(),f("div",{key:r.id,class:p([j(r),"card card-hover"]),onClick:C=>F(r)},[n("div",ye,[n("div",{class:p(B(r.type))},[n("i",{class:p(L(r.type))},null,2)],2),n("div",_e,[n("h4",pe,l(r.title),1),n("p",ge,l(r.message),1),n("p",be,l(V(r.created_at)),1)]),!r.read&&!r.is_read?(c(),f("button",{key:0,class:"w-2 h-2 rounded-full bg-primary",onClick:X(C=>q(r.id),["stop"])},null,8,ve)):x("",!0)])],10,he))),128))]))])]),_:1}))}});export{$e as default};
