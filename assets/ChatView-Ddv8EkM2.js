import{a as L,P as j,r as g,l as K,Y as P,p as U,w as I,Z as C,u as H,o as i,h as s,i as R,t as b,b as d,e as _,s as W,n as $,k as Y,F as Z,O as M,R as G,j as J,S as Q,W as X}from"./vue-vendor-DJ0JNZJp.js";import{s as h,u as ee,a as te,b as se}from"./index-DomtK_OL.js";import{u as ae}from"./documents-CDbBztGH.js";import{_ as re}from"./MainLayout.vue_vue_type_script_setup_true_lang-s1TSJ6UG.js";import"./supabase-aQ0K3vAX.js";import"./logofmd-DeXnOIzE.js";const w={async fetchMessages(c,l){let o=h.from("chats").select("*").eq("document_id",c).order("created_at",{ascending:!0});l&&(o=o.or(`sender_id.eq.${l},receiver_id.eq.${l}`));const{data:r,error:n}=await o;if(n)throw n;return(r||[]).map(u=>({...u,message_type:u.message_type||"text",status:u.status||"sent",read:u.read||!1}))},async sendMessage(c){const l={...c,message_type:c.message_type||"text",status:"sending",read:!1},{data:o,error:r}=await h.from("chats").insert([l]).select().single();if(r)throw r;const{data:n,error:u}=await h.from("chats").update({status:"sent",delivered_at:new Date().toISOString()}).eq("id",o.id).select().single();if(u)throw u;return n},async markAsRead(c){const{data:l,error:o}=await h.from("chats").update({read:!0,read_at:new Date().toISOString(),status:"read"}).eq("id",c).select().single();if(o)throw o;return l},async markAsDelivered(c){const{data:l,error:o}=await h.from("chats").update({status:"delivered",delivered_at:new Date().toISOString()}).eq("id",c).select().single();if(o)throw o;return l},subscribeToDocument(c,l){const o=h.channel(`chats:${c}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chats",filter:`document_id=eq.${c}`},r=>{const n=r.new;l({...n,message_type:n.message_type||"text",status:n.status||"sent",read:n.read||!1})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chats",filter:`document_id=eq.${c}`},r=>{const n=r.new;l({...n,message_type:n.message_type||"text",status:n.status||"sent",read:n.read||!1})}).subscribe();return()=>{h.removeChannel(o)}}},ne={class:"min-h-screen bg-gray-50 dark:bg-dark-bg flex flex-col"},oe={class:"bg-white dark:bg-dark-card border-b border-gray-200 dark:border-dark-border pt-safe px-4 py-3"},ie={class:"flex items-center space-x-3"},le={class:"flex-1"},de={class:"text-sm text-gray-500"},ce={key:0,class:"text-xs opacity-60 mb-1 border-l-2 pl-2"},ue={key:1,class:"mb-2"},fe=["src","alt"],me={key:2,class:"mb-2"},pe=["href"],_e={class:"text-sm"},he={key:0,class:"text-xs opacity-70"},xe={key:3,class:"mb-2"},ye={key:4,class:"text-sm"},ve={class:"flex items-center justify-end space-x-1 mt-1"},ge={class:"text-xs opacity-70"},be={key:0,class:"text-xs opacity-70"},ke={key:0,class:"fas fa-clock"},we={key:1,class:"fas fa-check"},De={key:2,class:"fas fa-check-double"},Se={key:3,class:"fas fa-check-double text-blue-500"},Ce={key:4,class:"fas fa-exclamation-circle text-red-500"},Re={key:0,class:"text-center py-12"},Te={class:"bg-white dark:bg-dark-card border-t border-gray-200 dark:border-dark-border p-4 pb-safe"},qe=["onKeydown"],Ne=L({__name:"ChatView",setup(c){const l=H(),o=j(),r=ee(),n=ae(),{error:u}=te(),y=o.params.documentId,x=g(""),k=g(null),m=g([]),T=g(!1),D=g("");let v=null;const q=()=>r.userId?!0:(l.push({name:"Login",query:{redirect:o.fullPath}}),!1),A=(a,t)=>{const e=r.userId,f=a.map(p=>p.sender_id===e?p.receiver_id:p.sender_id).find(p=>p&&p!==e);return f||(t&&t!==e?t:"")},E=async()=>{if(!q())return;T.value=!0;let a="";try{a=(await n.fetchDocumentById(y))?.data?.user_id||n.currentDocument?.user_id||"",m.value=await w.fetchMessages(y,r.userId||void 0),D.value=A(m.value,a);const e=m.value.filter(f=>f.receiver_id===r.userId&&!f.read);for(const f of e)try{await w.markAsRead(f.id),f.read=!0,f.status="read"}catch(p){console.error("Error marking message as read:",p)}}catch(t){u(t.message||"Erro ao carregar chat")}finally{T.value=!1}await C(),S(),N()},N=()=>{v||(v=w.subscribeToDocument(y,a=>{m.value.some(e=>e.id===a.id)||(m.value.push(a),C().then(S))}))},z=a=>`flex ${a===r.userId?"justify-end":"justify-start"}`,O=a=>{const t=a===r.userId,e="max-w-[75%] rounded-2xl px-4 py-2";return t?`${e} bg-primary text-white`:`${e} bg-white dark:bg-dark-card text-gray-900 dark:text-dark-text`},V=a=>new Date(a).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),F=a=>a<1024?a+" B":a<1024*1024?(a/1024).toFixed(1)+" KB":(a/(1024*1024)).toFixed(1)+" MB",B=async()=>{if(x.value.trim()&&q()){if(!D.value){u("Não foi possível identificar o destinatário.");return}try{const a=await w.sendMessage({document_id:y,sender_id:r.userId,receiver_id:D.value,message:x.value.trim()});m.value.push(a),x.value="",await C(),S()}catch(a){u(a.message||"Erro ao enviar mensagem")}}},S=()=>{k.value&&(k.value.scrollTop=k.value.scrollHeight)};return K(()=>{E()}),P(()=>{v&&(v(),v=null)}),(a,t)=>(i(),U(re,{"show-top-bar":!1},{default:I(()=>[s("div",ne,[s("header",oe,[s("div",ie,[s("button",{class:"btn-icon",onClick:t[0]||(t[0]=e=>R(l).back())},[...t[2]||(t[2]=[s("i",{class:"fas fa-arrow-left"},null,-1)])]),s("div",le,[t[3]||(t[3]=s("h3",{class:"font-semibold text-gray-900 dark:text-dark-text"},"Chat",-1)),s("p",de,"Documento #"+b(R(y).slice(0,8)),1)])])]),s("div",{class:"flex-1 overflow-y-auto p-4 space-y-4",ref_key:"messagesContainer",ref:k},[(i(!0),d(Z,null,W(m.value,e=>(i(),d("div",{key:e.id,class:$(z(e.sender_id))},[s("div",{class:$(O(e.sender_id))},[e.reply_to_id?(i(),d("div",ce,[...t[4]||(t[4]=[s("i",{class:"fas fa-reply"},null,-1),Y(" Respondendo... ",-1)])])):_("",!0),e.message_type==="image"&&e.file_url?(i(),d("div",ue,[s("img",{src:e.file_url,alt:e.message,class:"max-w-full rounded-lg"},null,8,fe)])):e.message_type==="file"&&e.file_url?(i(),d("div",me,[s("a",{href:e.file_url,target:"_blank",class:"flex items-center space-x-2 p-2 bg-black/10 rounded"},[t[5]||(t[5]=s("i",{class:"fas fa-file"},null,-1)),s("span",_e,b(e.file_name||"Arquivo"),1),e.file_size?(i(),d("span",he,b(F(e.file_size)),1)):_("",!0)],8,pe)])):e.message_type==="location"?(i(),d("div",xe,[...t[6]||(t[6]=[s("div",{class:"p-2 bg-black/10 rounded"},[s("i",{class:"fas fa-map-marker-alt mr-2"}),s("span",{class:"text-sm"},"Localização compartilhada")],-1)])])):_("",!0),e.message?(i(),d("p",ye,b(e.message),1)):_("",!0),s("div",ve,[s("p",ge,b(V(e.created_at)),1),e.sender_id===R(r).userId?(i(),d("span",be,[e.status==="sending"?(i(),d("i",ke)):e.status==="sent"?(i(),d("i",we)):e.status==="delivered"?(i(),d("i",De)):e.status==="read"?(i(),d("i",Se)):e.status==="failed"?(i(),d("i",Ce)):_("",!0)])):_("",!0)])],2)],2))),128)),m.value.length===0?(i(),d("div",Re,[...t[7]||(t[7]=[s("i",{class:"fas fa-comments text-gray-400 text-6xl mb-4"},null,-1),s("p",{class:"text-gray-500"},"Nenhuma mensagem ainda",-1),s("p",{class:"text-sm text-gray-400"},"Inicie a conversa!",-1)])])):_("",!0)],512),s("div",Te,[s("form",{onSubmit:M(B,["prevent"]),class:"flex items-end space-x-2"},[G(s("textarea",{"onUpdate:modelValue":t[1]||(t[1]=e=>x.value=e),placeholder:"Digite sua mensagem...",class:"input flex-1 min-h-[44px] max-h-32 resize-none",rows:"1",onKeydown:X(M(B,["exact","prevent"]),["enter"])},null,40,qe),[[Q,x.value]]),J(se,{type:"submit",variant:"primary",disabled:!x.value.trim()},{default:I(()=>[...t[8]||(t[8]=[s("i",{class:"fas fa-paper-plane"},null,-1)])]),_:1},8,["disabled"])],32)])])]),_:1}))}});export{Ne as default};
