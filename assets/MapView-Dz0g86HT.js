import{r as v,a as q,l as I,m as G,C as W,b,o as h,h as e,e as w,i as S,n as T,k as A,U as B,V as Y,c as M,p as O,w as _,t as $,j as z,F as J,u as K}from"./vue-vendor-BHw4onN5.js";import{u as Q}from"./documents-BOD2COYW.js";import{_ as X}from"./MainLayout.vue_vue_type_script_setup_true_lang-DPM7reLF.js";import{m as P}from"./maplibre-XFgcxNEv.js";import{B as j}from"./BaseModal-gFvbCxag.js";import{b as N}from"./index-QvtYAp7w.js";import"./logofmd-DeXnOIzE.js";import"./supabase-aQ0K3vAX.js";function Z(){const i=v({granted:!1,denied:!1,prompt:!0,checking:!1}),r=v({granted:!1,denied:!1,prompt:!0,checking:!1}),o=v({granted:!1,denied:!1,prompt:!0,checking:!1});return{locationPermission:i,cameraPermission:r,notificationPermission:o,checkLocationPermission:async()=>{if(!("geolocation"in navigator))return i.value.denied=!0,!1;try{if("permissions"in navigator){const t=await navigator.permissions.query({name:"geolocation"});return i.value.granted=t.state==="granted",i.value.denied=t.state==="denied",i.value.prompt=t.state==="prompt",t.state==="granted"}}catch{console.warn("Permissions API not supported")}return!1},requestLocationPermission:()=>new Promise((t,C)=>{i.value.checking=!0,navigator.geolocation.getCurrentPosition(k=>{i.value.granted=!0,i.value.denied=!1,i.value.prompt=!1,i.value.checking=!1,t(k)},k=>{i.value.checking=!1,k.code===k.PERMISSION_DENIED&&(i.value.denied=!0,i.value.granted=!1,i.value.prompt=!1),C(k)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}),checkCameraPermission:async()=>{try{if("permissions"in navigator){const t=await navigator.permissions.query({name:"camera"});return r.value.granted=t.state==="granted",r.value.denied=t.state==="denied",r.value.prompt=t.state==="prompt",t.state==="granted"}}catch{console.warn("Camera permission check not supported")}return!1},requestCameraPermission:async()=>{r.value.checking=!0;try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});return r.value.granted=!0,r.value.denied=!1,r.value.prompt=!1,r.value.checking=!1,t}catch(t){throw r.value.checking=!1,(t.name==="NotAllowedError"||t.name==="PermissionDeniedError")&&(r.value.denied=!0,r.value.granted=!1,r.value.prompt=!1),t}},checkNotificationPermission:()=>"Notification"in window?(o.value.granted=Notification.permission==="granted",o.value.denied=Notification.permission==="denied",o.value.prompt=Notification.permission==="default",Notification.permission==="granted"):(o.value.denied=!0,!1),requestNotificationPermission:async()=>{if(!("Notification"in window))throw new Error("Notificações não são suportadas neste navegador");o.value.checking=!0;try{const t=await Notification.requestPermission();return o.value.granted=t==="granted",o.value.denied=t==="denied",o.value.prompt=t==="default",o.value.checking=!1,t==="granted"}catch(t){throw o.value.checking=!1,t}},isMobile:()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),isAndroid:()=>/Android/i.test(navigator.userAgent),isIOS:()=>/iPhone|iPad|iPod/i.test(navigator.userAgent)}}function ee(i){const r=new Date,o=typeof i=="string"?new Date(i):i,f=r.getTime()-o.getTime(),p=Math.floor(f/1e3),a=Math.floor(p/60),l=Math.floor(a/60),m=Math.floor(l/24),c=Math.floor(m/7),u=Math.floor(m/30),d=Math.floor(m/365);return p<60?"Agora":a<60?`${a}m`:l<24?`${l}h`:m<7?`${m}d`:c<4?`${c} sem${c>1?"s":""}`:u<12?`${u} mês${u>1?"es":""}`:`${d} ano${d>1?"s":""}`}function te(){const i=v(null),r=v(null),o=v(!1),f="geolocation"in navigator,p=async()=>f?(o.value=!0,r.value=null,new Promise(c=>{navigator.geolocation.getCurrentPosition(u=>{const d={latitude:u.coords.latitude,longitude:u.coords.longitude,accuracy:u.coords.accuracy};i.value=d,o.value=!1,c(d)},u=>{r.value={code:u.code,message:m(u.code)},o.value=!1,c(null)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})})):(r.value={code:0,message:"Geolocalização não suportada neste navegador"},null),a=c=>f?navigator.geolocation.watchPosition(d=>{const g={latitude:d.coords.latitude,longitude:d.coords.longitude,accuracy:d.coords.accuracy};i.value=g,c(g)},d=>{r.value={code:d.code,message:m(d.code)}},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):(r.value={code:0,message:"Geolocalização não suportada neste navegador"},null),l=c=>{f&&c&&navigator.geolocation.clearWatch(c)},m=c=>{switch(c){case 1:return"Permissão de localização negada";case 2:return"Localização indisponível";case 3:return"Tempo limite excedido";default:return"Erro ao obter localização"}};return{coordinates:i,error:r,isLoading:o,isSupported:f,getCurrentPosition:p,watchPosition:a,clearWatch:l}}const ae={class:"relative w-full h-full"},se={key:0,class:"absolute inset-0 bg-white/80 dark:bg-dark-bg/80 flex items-center justify-center z-10"},oe={class:"absolute top-4 right-4 space-y-2 z-10"},ne=["disabled"],ie={class:"absolute bottom-4 left-4 bg-white dark:bg-dark-card rounded-lg shadow-lg p-3 z-10"},le={class:"space-y-2 text-sm"},re={key:0,class:"flex items-center space-x-2"},de={key:1,class:"absolute top-4 left-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-10"},ce=q({__name:"MapComponent",props:{documents:{default:()=>[]},center:{default:()=>[-25.9655,32.5832]},zoom:{default:12},enableMarking:{type:Boolean,default:!1}},emits:["markerClick","locationMarked","navigate"],setup(i,{emit:r}){const o=i,f=r,p=v(null),a=v(!0),l=v(null),m=v([]),c=v(null),u=v(null),d=v(!1),{coordinates:g,getCurrentPosition:t}=te();I(async()=>{C(),await V()}),G(()=>{l.value&&l.value.remove()}),W(()=>o.documents,()=>{k()},{deep:!0});const C=()=>{p.value&&(l.value=new P.Map({container:p.value,style:{version:8,sources:{"osm-tiles":{type:"raster",tiles:["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png","https://b.tile.openstreetmap.org/{z}/{x}/{y}.png","https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"© OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"osm-tiles",minzoom:0,maxzoom:19}]},center:[o.center[1],o.center[0]],zoom:o.zoom}),l.value.addControl(new P.NavigationControl,"bottom-right"),l.value.on("click",s=>{d.value&&x(s.lngLat.lat,s.lngLat.lng)}),l.value.on("load",()=>{a.value=!1,k()}))},k=()=>{if(l.value&&(m.value.forEach(s=>s.remove()),m.value=[],o.documents.forEach(s=>{if(!s.location_metadata?.lat||!s.location_metadata?.lng)return;const{lat:n,lng:L}=s.location_metadata,D=document.createElement("div");D.className="custom-marker";const H=s.status==="lost"?"#DC3545":"#28A745",F=s.status==="lost"?"fa-search":"fa-check";D.innerHTML=`
      <div style="
        background-color: ${H};
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        cursor: pointer;
      ">
        <i class="fas ${F}"></i>
      </div>
    `;const R=new P.Popup({offset:25}).setHTML(`
      <div class="p-2">
        <h4 class="font-semibold mb-1">${s.title}</h4>
        <p class="text-sm text-gray-600 mb-2">${s.description||"Sem descrição"}</p>
        <p class="text-xs text-gray-500 mb-2">${s.location||"Localização não especificada"}</p>
        <button 
          onclick="window.navigateToDocument('${s.id}')" 
          class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-primary-dark"
        >
          Ver detalhes
        </button>
        <button 
          onclick="window.navigateToLocation(${n}, ${L})" 
          class="text-xs bg-success text-white px-3 py-1 rounded hover:bg-success-dark ml-1"
        >
          <i class="fas fa-directions"></i> Navegar
        </button>
      </div>
    `),U=new P.Marker({element:D}).setLngLat([L,n]).setPopup(R).addTo(l.value);D.addEventListener("click",()=>f("markerClick",s)),m.value.push(U)}),m.value.length>0)){const s=new P.LngLatBounds;o.documents.forEach(n=>{n.location_metadata?.lat&&n.location_metadata?.lng&&s.extend([n.location_metadata.lng,n.location_metadata.lat])}),l.value.fitBounds(s,{padding:50})}},V=async()=>{const s=await t();if(s&&l.value){const n=document.createElement("div");n.innerHTML=`
      <div style="
        background-color: #007BFF;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      "></div>
    `,c.value&&c.value.remove(),c.value=new P.Marker({element:n}).setLngLat([s.longitude,s.latitude]).setPopup(new P.Popup().setHTML("<p>Você está aqui</p>")).addTo(l.value)}},E=()=>{g.value&&l.value&&l.value.flyTo({center:[g.value.longitude,g.value.latitude],zoom:15})},y=()=>{d.value=!d.value,!d.value&&u.value&&(u.value.remove(),u.value=null)},x=(s,n)=>{if(!l.value)return;u.value&&u.value.remove();const L=document.createElement("div");L.innerHTML=`
    <div style="
      background-color: #FFC107;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      animation: pulse 2s infinite;
    ">
      <i class="fas fa-map-marker-alt"></i>
    </div>
  `,u.value=new P.Marker({element:L}).setLngLat([n,s]).addTo(l.value),f("locationMarked",{lat:s,lng:n}),d.value=!1};return typeof window<"u"&&(window.navigateToDocument=s=>{window.location.href=`/document/${s}`},window.navigateToLocation=(s,n)=>{f("navigate",{lat:s,lng:n});const L=`https://www.google.com/maps/dir/?api=1&destination=${s},${n}`;window.open(L,"_blank")}),(s,n)=>(h(),b("div",ae,[e("div",{ref_key:"mapContainer",ref:p,class:"w-full h-full rounded-lg overflow-hidden"},null,512),a.value?(h(),b("div",se,[...n[0]||(n[0]=[e("div",{class:"text-center"},[e("div",{class:"spinner mb-2"}),e("p",{class:"text-sm text-gray-600 dark:text-gray-400"},"Carregando mapa...")],-1)])])):w("",!0),e("div",oe,[e("button",{class:"btn-icon bg-white dark:bg-dark-card shadow-lg",onClick:E,disabled:!S(g),title:"Centralizar na minha localização"},[...n[1]||(n[1]=[e("i",{class:"fas fa-crosshairs"},null,-1)])],8,ne),i.enableMarking?(h(),b("button",{key:0,class:T(["btn-icon bg-white dark:bg-dark-card shadow-lg",{"bg-primary text-white":d.value}]),onClick:y,title:"Marcar localização"},[...n[2]||(n[2]=[e("i",{class:"fas fa-map-pin"},null,-1)])],2)):w("",!0)]),e("div",ie,[e("div",le,[n[4]||(n[4]=e("div",{class:"flex items-center space-x-2"},[e("div",{class:"w-3 h-3 rounded-full",style:{"background-color":"#DC3545"}}),e("span",null,"Perdidos")],-1)),n[5]||(n[5]=e("div",{class:"flex items-center space-x-2"},[e("div",{class:"w-3 h-3 rounded-full",style:{"background-color":"#28A745"}}),e("span",null,"Recuperados")],-1)),S(g)?(h(),b("div",re,[...n[3]||(n[3]=[e("div",{class:"w-3 h-3 rounded-full",style:{"background-color":"#007BFF"}},null,-1),e("span",null,"Você",-1)])])):w("",!0)])]),d.value?(h(),b("div",de,[...n[6]||(n[6]=[e("i",{class:"fas fa-info-circle mr-2"},null,-1),A(" Clique no mapa para marcar a localização ",-1)])])):w("",!0)]))}}),ue={class:"space-y-4"},me={class:"text-center"},fe={class:"text-lg font-semibold text-gray-900 dark:text-dark-text mb-2"},pe={class:"text-sm text-gray-600 dark:text-gray-400"},ve={key:0,class:"bg-red-50 dark:bg-red-900/20 rounded-lg p-4"},ge={key:0,class:"space-y-2 text-xs text-red-700 dark:text-red-300"},xe={key:0},he={key:1},be={key:1,class:"space-y-2 text-xs text-red-700 dark:text-red-300"},ke={class:"flex space-x-3"},ye=q({__name:"LocationPermissionModal",props:B({title:{},message:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:B(["allow","deny"],["update:modelValue"]),setup(i,{emit:r}){const o=Y(i,"modelValue"),f=r,p=v(!1),a=v(!1),l=M(()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)),m=M(()=>/Android/i.test(navigator.userAgent)),c=M(()=>/iPhone|iPad|iPod/i.test(navigator.userAgent)),u=async()=>{p.value=!0,a.value=!1;try{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(()=>{p.value=!1,f("allow"),o.value=!1},g=>{p.value=!1,g.code===g.PERMISSION_DENIED&&(a.value=!0),f("deny")}):(p.value=!1,alert("Geolocalização não é suportada neste navegador"),f("deny"))}catch{p.value=!1,f("deny")}},d=()=>{f("deny"),o.value=!1};return(g,t)=>(h(),O(j,{modelValue:o.value,"onUpdate:modelValue":t[0]||(t[0]=C=>o.value=C),title:"Permissão de Localização",maxWidth:"md"},{footer:_(()=>[e("div",ke,[z(N,{variant:"secondary","full-width":"",onClick:d},{default:_(()=>[...t[9]||(t[9]=[A(" Agora não ",-1)])]),_:1}),z(N,{variant:"primary","full-width":"",onClick:u,loading:p.value},{default:_(()=>[...t[10]||(t[10]=[A(" Permitir Localização ",-1)])]),_:1},8,["loading"])])]),default:_(()=>[e("div",ue,[t[6]||(t[6]=e("div",{class:"flex justify-center"},[e("div",{class:"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center"},[e("i",{class:"fas fa-map-marker-alt text-3xl text-primary"})])],-1)),e("div",me,[e("h3",fe,$(i.title||"Precisamos da sua localização"),1),e("p",pe,$(i.message||"Para ajudar a encontrar documentos perdidos próximos a você."),1)]),t[7]||(t[7]=e("div",{class:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 space-y-2"},[e("p",{class:"text-sm font-semibold text-blue-900 dark:text-blue-100"}," Por que precisamos disso? "),e("ul",{class:"space-y-1 text-sm text-blue-700 dark:text-blue-300"},[e("li",{class:"flex items-start space-x-2"},[e("i",{class:"fas fa-check text-xs mt-0.5"}),e("span",null,"Mostrar documentos perdidos perto de você")]),e("li",{class:"flex items-start space-x-2"},[e("i",{class:"fas fa-check text-xs mt-0.5"}),e("span",null,"Ajudar outros a encontrarem seus documentos")]),e("li",{class:"flex items-start space-x-2"},[e("i",{class:"fas fa-check text-xs mt-0.5"}),e("span",null,"Registrar onde você perdeu/encontrou")])])],-1)),t[8]||(t[8]=e("p",{class:"text-xs text-gray-500 dark:text-gray-400 text-center"},[e("i",{class:"fas fa-lock mr-1"}),A(" Sua localização é usada apenas quando você permite e nunca é compartilhada sem seu consentimento. ")],-1)),a.value?(h(),b("div",ve,[t[4]||(t[4]=e("p",{class:"text-sm font-semibold text-red-900 dark:text-red-100 mb-2"}," Permissão Negada ",-1)),t[5]||(t[5]=e("p",{class:"text-xs text-red-700 dark:text-red-300 mb-3"}," Para habilitar a localização, siga as instruções: ",-1)),l.value?(h(),b("div",ge,[m.value?(h(),b("div",xe,[...t[1]||(t[1]=[e("p",{class:"font-semibold"},"Android (Chrome):",-1),e("ol",{class:"list-decimal list-inside space-y-1 ml-2"},[e("li",null,"Abra Configurações do Chrome"),e("li",null,'Toque em "Configurações do site"'),e("li",null,'Toque em "Localização"'),e("li",null,"Habilite para este site")],-1)])])):c.value?(h(),b("div",he,[...t[2]||(t[2]=[e("p",{class:"font-semibold"},"iOS (Safari):",-1),e("ol",{class:"list-decimal list-inside space-y-1 ml-2"},[e("li",null,"Abra Ajustes do iPhone"),e("li",null,"Role até Safari"),e("li",null,'Toque em "Localização"'),e("li",null,'Selecione "Perguntar" ou "Permitir"')],-1)])])):w("",!0)])):(h(),b("div",be,[...t[3]||(t[3]=[e("p",{class:"font-semibold"},"Desktop:",-1),e("ol",{class:"list-decimal list-inside space-y-1 ml-2"},[e("li",null,"Clique no ícone de cadeado/informação na barra de endereço"),e("li",null,'Procure "Localização"'),e("li",null,'Altere para "Permitir"'),e("li",null,"Recarregue a página")],-1)])]))])):w("",!0)])]),_:1},8,["modelValue"]))}}),we={class:"h-[calc(100vh-8rem)]"},Pe={key:0,class:"aspect-video bg-gray-200 dark:bg-dark-card rounded-lg overflow-hidden mb-4"},Me=["src","alt"],_e={class:"space-y-3"},Ce={class:"flex items-center space-x-2"},Le={class:"badge badge-primary"},$e={key:0,class:"text-sm text-gray-600 dark:text-gray-400"},ze={class:"space-y-2 text-sm"},Ae={class:"flex items-start"},De={class:"flex items-start"},Ne={class:"flex space-x-2 mt-4 pt-4 border-t border-gray-200 dark:border-dark-border"},je=q({__name:"MapView",setup(i){const r=K(),o=Q(),{checkLocationPermission:f,locationPermission:p}=Z(),a=v(null),l=v(!1),m=v(!1),c=M(()=>o.documents),u=M(()=>a.value?{lost:"badge badge-danger",found:"badge badge-success",matched:"badge bg-purple-500/10 text-purple-500",returned:"badge badge-success"}[a.value.status]||"badge badge-primary":""),d=M(()=>a.value?{lost:"Perdido",found:"Encontrado",matched:"Match",returned:"Devolvido",normal:"Normal"}[a.value.status]||a.value.status:""),g=M(()=>a.value?{passport:"fas fa-passport",id_card:"fas fa-id-card",driver_license:"fas fa-id-card-alt",birth_certificate:"fas fa-file-alt",other:"fas fa-file"}[a.value.type]||"fas fa-file":""),t=M(()=>a.value?{passport:"Passaporte",id_card:"BI",driver_license:"Carta",birth_certificate:"Certidão",other:"Outro"}[a.value.type]||"Documento":""),C=y=>{a.value=y,l.value=!0},k=()=>{a.value&&r.push(`/document/${a.value.id}`)},V=()=>{console.log("Location permission granted")},E=()=>{console.log("Location permission denied")};return I(async()=>{c.value.length===0&&await o.fetchDocuments(),!await f()&&p.value.prompt&&setTimeout(()=>{m.value=!0},1e3)}),(y,x)=>(h(),O(X,null,{default:_(()=>[e("div",we,[z(ce,{documents:c.value,onMarkerClick:C},null,8,["documents"])]),z(ye,{modelValue:m.value,"onUpdate:modelValue":x[0]||(x[0]=s=>m.value=s),title:"Ver Documentos no Mapa",message:"Precisamos da sua localização para mostrar documentos perdidos próximos a você.",onAllow:V,onDeny:E},null,8,["modelValue"]),z(j,{modelValue:l.value,"onUpdate:modelValue":x[2]||(x[2]=s=>l.value=s),title:a.value?.title},{default:_(()=>[a.value?(h(),b(J,{key:0},[a.value.thumbnail_url||a.value.file_url?(h(),b("div",Pe,[e("img",{src:a.value.thumbnail_url||a.value.file_url,alt:a.value.title,class:"w-full h-full object-cover"},null,8,Me)])):w("",!0),e("div",_e,[e("div",Ce,[e("span",{class:T(u.value)},$(d.value),3),e("span",Le,[e("i",{class:T([g.value,"mr-1"])},null,2),A(" "+$(t.value),1)])]),a.value.description?(h(),b("p",$e,$(a.value.description),1)):w("",!0),e("div",ze,[e("div",Ae,[x[3]||(x[3]=e("i",{class:"fas fa-map-marker-alt text-gray-400 w-5 mt-0.5"},null,-1)),e("span",null,$(a.value.location||"Localização não especificada"),1)]),e("div",De,[x[4]||(x[4]=e("i",{class:"fas fa-clock text-gray-400 w-5 mt-0.5"},null,-1)),e("span",null,$(S(ee)(a.value.created_at)),1)])])]),e("div",Ne,[z(N,{variant:"primary",class:"flex-1",onClick:k},{default:_(()=>[...x[5]||(x[5]=[A(" Ver Detalhes ",-1)])]),_:1}),z(N,{variant:"outline",onClick:x[1]||(x[1]=s=>l.value=!1)},{default:_(()=>[...x[6]||(x[6]=[A(" Fechar ",-1)])]),_:1})])],64)):w("",!0)]),_:1},8,["modelValue","title"])]),_:1}))}});export{je as default};
