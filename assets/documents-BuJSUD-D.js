const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/documentMatching-DxxgVOs1.js","assets/index-kKZCKLVg.js","assets/vue-vendor-CG29anWM.js","assets/supabase-DO0Dm75k.js","assets/index-DmGHoXpu.css"])))=>i.map(i=>d[i]);
var d=(l,n,a)=>new Promise((r,i)=>{var h=c=>{try{w(a.next(c))}catch(b){i(b)}},E=c=>{try{w(a.throw(c))}catch(b){i(b)}},w=c=>c.done?r(c.value):Promise.resolve(c.value).then(h,E);w((a=a.apply(l,n)).next())});import{s as v,c as O}from"./index-kKZCKLVg.js";import{d as V,r as _,c as z}from"./vue-vendor-CG29anWM.js";const R=V("documents",()=>{const l=_([]),n=_(null),a=_(!1),r=_(null),i=_(!0),h=_(0),E=20,w=z(()=>l.value.filter(t=>t.status==="lost")),c=z(()=>l.value.filter(t=>t.status==="found"));function b(t=!1){return d(this,null,function*(){if(t&&(h.value=0,l.value=[],i.value=!0),!i.value&&!t)return{success:!0};a.value=!0,r.value=null;try{const e=h.value*E,u=e+E-1,{data:s,error:f}=yield v.from("documents").select("*").in("status",["lost","found"]).order("created_at",{ascending:!1}).range(e,u);if(f)throw f;return s&&(t?l.value=s:l.value.push(...s),i.value=s.length===E,s.length>0&&h.value++),{success:!0}}catch(e){return r.value=e.message||"Erro ao carregar documentos",{success:!1,error:r.value}}finally{a.value=!1}})}function P(t,e=!1){return d(this,null,function*(){e&&(l.value=[]),a.value=!0,r.value=null;try{const{data:u,error:s}=yield v.from("documents").select("*").eq("user_id",t).order("created_at",{ascending:!1});if(s)throw s;return u&&(l.value=u),{success:!0}}catch(u){return r.value=u.message||"Erro ao carregar documentos",{success:!1,error:r.value}}finally{a.value=!1}})}function $(t){return d(this,null,function*(){a.value=!0,r.value=null;try{const{data:e,error:u}=yield v.from("documents").select("*").eq("id",t).single();if(u)throw u;return e&&(n.value=e),{success:!0,data:e}}catch(e){return r.value=e.message||"Erro ao carregar documento",{success:!1,error:r.value}}finally{a.value=!1}})}function D(t,e){return d(this,null,function*(){var u,s,f;a.value=!0,r.value=null;try{let m="",p="";if(e.file){const S=e.file.name.split(".").pop();p=`documents/${`${t}_${Date.now()}.${S}`}`;const{error:y}=yield v.storage.from("documents").upload(p,e.file,{cacheControl:"3600",upsert:!1});if(y)throw console.error("Storage upload error:",y),new Error(`Erro ao fazer upload do arquivo: ${y.message}. Verifique se o bucket 'documents' estÃ¡ criado no Supabase Storage.`);const{data:g}=v.storage.from("documents").getPublicUrl(p);m=g.publicUrl}const N={user_id:t,title:e.title,type:e.type,status:e.status,description:e.description||"",location:e.location||"",document_number:e.documentNumber||"",issue_date:e.issueDate||null,expiry_date:e.expiryDate||null,issue_place:e.issuePlace||"",issuing_authority:e.issuingAuthority||"",country_of_issue:e.countryOfIssue||"",file_url:m,file_path:p,file_name:((u=e.file)==null?void 0:u.name)||"",file_size:((s=e.file)==null?void 0:s.size)||null,file_type:((f=e.file)==null?void 0:f.type)||"",is_verified:!1,verification_status:"pending",is_public:!0,is_archived:!1},{data:o,error:x}=yield v.from("documents").insert([N]).select().single();if(x)throw x;return o&&(l.value.unshift(o),(o.status==="lost"||o.status==="found")&&O(()=>d(this,null,function*(){const{findDocumentMatches:S,notifyMatch:q}=yield import("./documentMatching-DxxgVOs1.js");return{findDocumentMatches:S,notifyMatch:q}}),__vite__mapDeps([0,1,2,3,4])).then(({findDocumentMatches:S,notifyMatch:q})=>{S(o).then(y=>{if(y.length>0){const g=y[0];if(g.matchScore>=50){const A=o.status==="lost"?o:g.document,L=o.status==="found"?o:g.document;q(A,L,g.matchScore)}}})})),{success:!0,data:o}}catch(m){return r.value=m.message||"Erro ao criar documento",{success:!1,error:r.value}}finally{a.value=!1}})}function M(t,e){return d(this,null,function*(){var u;a.value=!0,r.value=null;try{const{data:s,error:f}=yield v.from("documents").update(e).eq("id",t).select().single();if(f)throw f;if(s){const m=l.value.findIndex(p=>p.id===t);m!==-1&&(l.value[m]=s),((u=n.value)==null?void 0:u.id)===t&&(n.value=s)}return{success:!0,data:s}}catch(s){return r.value=s.message||"Erro ao atualizar documento",{success:!1,error:r.value}}finally{a.value=!1}})}function U(t){return d(this,null,function*(){var e;a.value=!0,r.value=null;try{const{error:u}=yield v.from("documents").delete().eq("id",t);if(u)throw u;return l.value=l.value.filter(s=>s.id!==t),((e=n.value)==null?void 0:e.id)===t&&(n.value=null),{success:!0}}catch(u){return r.value=u.message||"Erro ao deletar documento",{success:!1,error:r.value}}finally{a.value=!1}})}function I(){l.value=[],n.value=null,h.value=0,i.value=!0}return{documents:l,currentDocument:n,isLoading:a,error:r,hasMore:i,lostDocuments:w,foundDocuments:c,fetchDocuments:b,fetchUserDocuments:P,fetchDocumentById:$,createDocument:D,updateDocument:M,deleteDocument:U,clearDocuments:I}});export{R as u};
