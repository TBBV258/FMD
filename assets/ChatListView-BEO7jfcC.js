var C=(m,p,s)=>new Promise((h,y)=>{var g=r=>{try{n(s.next(r))}catch(u){y(u)}},i=r=>{try{n(s.throw(r))}catch(u){y(u)}},n=r=>r.done?h(r.value):Promise.resolve(r.value).then(g,i);n((s=s.apply(m,p)).next())});import{r as w,c as B,a as $,l as D,C as L,p as M,w as j,o as _,h as l,b as f,e as b,i as x,t as v,F as T,s as A,u as E}from"./vue-vendor-CG29anWM.js";import{u as I}from"./index-kKZCKLVg.js";import{s as S}from"./supabase-B9ALGzFB.js";import{_ as N}from"./MainLayout.vue_vue_type_script_setup_true_lang-BMMkysOY.js";import"./supabase-DO0Dm75k.js";import"./logofmd-DeXnOIzE.js";function V(m){const p=w([]),s=w(!1),h=w(null),y=()=>C(this,null,function*(){s.value=!0,h.value=null;const{data:i,error:n}=yield S.from("chats").select("*").or(`sender_id.eq.${m},receiver_id.eq.${m}`).order("created_at",{ascending:!1});if(n)return h.value=n.message,s.value=!1,[];const r=new Map;(i!=null?i:[]).forEach(e=>{const a=e.sender_id===m?e.receiver_id:e.sender_id,t=e.document_id&&e.document_id.length>0?`document:${e.document_id}`:`users:${[m,a].sort().join("-")}`,o=e.receiver_id===m&&!e.read?1:0,d=r.get(t);d?((!d.last_message||new Date(e.created_at).getTime()>new Date(d.last_message.created_at).getTime())&&(d.last_message=e),d.unread_count+=o):r.set(t,{threadKey:t,document_id:e.document_id,other_user_id:a,last_message:e,unread_count:o})});const u=Array.from(r.values()).sort((e,a)=>{var t,o,d,k;return((o=(t=a.last_message)==null?void 0:t.created_at)!=null?o:"").localeCompare((k=(d=e.last_message)==null?void 0:d.created_at)!=null?k:"")}),c=[...new Set(u.map(e=>e.other_user_id))].filter(Boolean);if(c.length){const{data:e}=yield S.from("user_profiles").select("id, full_name, avatar_url").in("id",c),a=new Map((e!=null?e:[]).map(t=>[t.id,{full_name:t.full_name,avatar_url:t.avatar_url}]));u.forEach(t=>{var d,k;const o=a.get(t.other_user_id);t.other_user_avatar_url=(d=o==null?void 0:o.avatar_url)!=null?d:null,t.other_user_name=(k=o==null?void 0:o.full_name)!=null?k:"Usuário"})}return p.value=u,s.value=!1,p.value}),g=B(()=>p.value.reduce((i,n)=>i+n.unread_count,0));return{previews:p,loading:s,error:h,unreadTotal:g,loadChatHistoryList:y}}const q={class:"max-w-3xl mx-auto px-4 py-8"},F={class:"flex items-center justify-between mb-4"},H={key:0,class:"text-sm text-primary font-semibold"},K={key:0,class:"text-gray-500 dark:text-gray-400"},R={key:1,class:"text-red-600"},z={key:2,class:"space-y-3"},G=["onClick"],J=["src"],O={class:"flex-1 min-w-0"},P={class:"font-semibold text-gray-900 dark:text-dark-text truncate"},Q={class:"text-sm text-gray-600 dark:text-gray-400 line-clamp-1"},W={class:"text-right"},X={class:"text-xs text-gray-400"},Y={key:0,class:"ml-auto inline-flex min-w-6 justify-center rounded-full bg-primary px-2 py-1 text-xs font-semibold text-white"},Z={key:0,class:"text-center text-gray-500 py-8"},ne=$({__name:"ChatListView",setup(m){const p=E(),s=I(),{previews:h,loading:y,error:g,unreadTotal:i,loadChatHistoryList:n}=V(s.userId||""),r=c=>{c.document_id&&p.push({name:"Chat",params:{documentId:c.document_id}})},u=c=>new Date(c).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"});return D(()=>{s.userId&&n()}),L(()=>s.userId,c=>{c&&n()}),(c,e)=>(_(),M(N,null,{default:j(()=>[l("section",q,[l("div",F,[e[0]||(e[0]=l("div",null,[l("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-dark-text"},"Conversas"),l("p",{class:"text-sm text-gray-500 dark:text-gray-400"}," Suas conversas por documento ou usuário ")],-1)),x(i)?(_(),f("span",H,v(x(i))+" não lida(s) ",1)):b("",!0)]),x(y)?(_(),f("div",K,"Carregando...")):x(g)?(_(),f("div",R,v(x(g)),1)):(_(),f("ul",z,[(_(!0),f(T,null,A(x(h),a=>{var t;return _(),f("li",{key:a.threadKey,class:"flex items-center gap-3 rounded-lg border border-gray-200 dark:border-dark-border bg-white dark:bg-dark-card p-3 shadow-sm cursor-pointer hover:border-primary transition",onClick:o=>r(a)},[l("img",{src:a.other_user_avatar_url||"https://placehold.co/48x48",alt:"Avatar",class:"h-12 w-12 rounded-full object-cover"},null,8,J),l("div",O,[l("p",P,v(a.other_user_name||"Contato"),1),l("p",Q,v(((t=a.last_message)==null?void 0:t.message)||"Sem mensagens"),1)]),l("div",W,[l("p",X,v(a.last_message?u(a.last_message.created_at):""),1),a.unread_count?(_(),f("span",Y,v(a.unread_count),1)):b("",!0)])],8,G)}),128)),x(h).length===0?(_(),f("li",Z," Nenhuma conversa encontrada. ")):b("",!0)]))])]),_:1}))}});export{ne as default};
