import{s as v}from"./index-DxLkO65O.js";import{r as c,c as C}from"./vue-vendor-DJ0JNZJp.js";function w(h){const a=c(h),t=c([]),d=c(!1),i=c(null),m=s=>{a.value=s},p=async()=>{if(!a.value)return t.value=[],[];d.value=!0,i.value=null,console.log("[useChat] Loading chat history for user:",a.value);let s=null,u=null;{const e=await v.from("chats").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});console.log("[useChat] Chats query result:",{data:e.data,error:e.error}),s=e.data,u=e.error}if(!s?.length){const e=await v.from("messages").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});e.data?.length&&(s=e.data,u=e.error)}if(u)return i.value=u.message,d.value=!1,[];const _={}(s??[]).forEach(e=>{const o=e.sender_id===a.value?e.receiver_id:e.sender_id,l=e.document_id!==null&&e.document_id!==void 0?`document:${e.document_id}`:`users:${[a.value,o].sort().join("-")}`,r=e.receiver_id===a.value&&!e.read?1:0,n=_[l];n?((!n.last_message||e.created_at>n.last_message.created_at)&&(n.last_message=e),n.unread_count+=r):_[l]={threadKey:l,document_id:e.document_id,other_user_id:o,last_message:e,unread_count:r}});t.value=Object.values(_).sort((e,o)=>(o.last_message?.created_at??"").localeCompare(e.last_message?.created_at??""));const f=[...new Set(t.value.map(e=>e.other_user_id))];if(f.length){const{data:e,error:o}=await v.from("user_profiles").select("id, avatar_url, full_name").in("id",f);if(!o&&e){const l={};e.forEach(r=>{l[r.id]={avatar_url:r.avatar_url,full_name:r.full_name}}),t.value=t.value.map(r=>({...r,other_user_avatar_url:l[r.other_user_id]?.avatar_url??null,other_user_name:l[r.other_user_id]?.full_name??"UsuÃ¡rio"}))}}return d.value=!1,t.value},g=C(()=>t.value.reduce((s,u)=>s+u.unread_count,0));return{previews:t,loading:d,error:i,loadChatHistoryList:p,unreadTotal:g,setCurrentUserId:m}}export{w as u};
