import{s as m}from"./index-QvtYAp7w.js";import"./vue-vendor-BHw4onN5.js";import"./supabase-aQ0K3vAX.js";async function M(t){try{const o=t.status==="lost"?"found":"lost",{data:s,error:n}=await m.from("documents").select("*").eq("type",t.type).eq("status",o).neq("user_id",t.user_id).gte("created_at",new Date(Date.now()-30*24*60*60*1e3).toISOString());if(n)throw n;if(!s||s.length===0)return[];const i=[];for(const e of s){let a=0;const r=[];if(t.document_number&&e.document_number&&t.document_number.toLowerCase()===e.document_number.toLowerCase()&&(a+=50,r.push("Número do documento coincide")),t.location_metadata?.lat&&e.location_metadata?.lat){const c=h(t.location_metadata.lat,t.location_metadata.lng||0,e.location_metadata.lat,e.location_metadata.lng||0);c<5?(a+=30,r.push("Localização muito próxima")):c<20?(a+=15,r.push("Localização próxima")):c<50&&(a+=5,r.push("Mesma região"))}const u=Math.abs(new Date(t.created_at).getTime()-new Date(e.created_at).getTime())/(1e3*60*60*24);if(u<3?(a+=15,r.push("Reportado recentemente")):u<7&&(a+=10,r.push("Reportado na mesma semana")),t.title&&e.title){const c=f(t.title,e.title);c>.5&&(a+=Math.floor(c*10),r.push("Descrição similar"))}a>=20&&i.push({document:e,matchScore:a,matchReasons:r})}return i.sort((e,a)=>a.matchScore-e.matchScore),i}catch(o){return console.error("Error finding matches:",o),[]}}async function g(t,o,s){try{const n=[{user_id:t.user_id,type:"match",title:"Possível Match Encontrado!",message:`Encontramos um documento ${o.type} que pode ser o seu.`,data:{documentId:o.id,matchScore:s,matchedWith:t.id},read:!1,created_at:new Date().toISOString()},{user_id:o.user_id,type:"match",title:"Possível Dono Encontrado!",message:`Alguém reportou a perda de um documento ${t.type} que pode ser o que você encontrou.`,data:{documentId:t.id,matchScore:s,matchedWith:o.id},read:!1,created_at:new Date().toISOString()}],{error:i}=await m.from("notifications").insert(n);if(i)throw i;return{success:!0}}catch(n){return console.error("Error creating match notifications:",n),{success:!1,error:n}}}function h(t,o,s,n){const e=d(s-t),a=d(n-o),r=Math.sin(e/2)*Math.sin(e/2)+Math.cos(d(t))*Math.cos(d(s))*Math.sin(a/2)*Math.sin(a/2);return 6371*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}function d(t){return t*(Math.PI/180)}function f(t,o){const s=new Set(t.toLowerCase().split(/\s+/)),n=new Set(o.toLowerCase().split(/\s+/)),i=new Set([...s].filter(a=>n.has(a))),e=new Set([...s,...n]);return i.size/e.size}export{M as findDocumentMatches,g as notifyMatch};
