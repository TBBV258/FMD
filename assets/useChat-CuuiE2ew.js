import{s as v}from"./index-CzWhD5j9.js";import{r as i,c as w}from"./vue-vendor-DJ0JNZJp.js";function y(m){const a=i(m),t=i([]),d=i(!1),c=i(null),h=s=>{a.value=s},p=async()=>{if(!a.value)return t.value=[],[];d.value=!0,c.value=null,console.log("[useChat] Loading chat history for user:",a.value);let s=null,l=null;{const e=await v.from("chats").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});console.log("[useChat] Chats query result:",{data:e.data,error:e.error}),s=e.data,l=e.error}if(!s?.length){const e=await v.from("messages").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});e.data?.length&&(s=e.data,l=e.error)}if(l)return c.value=l.message,d.value=!1,[];const _=new Map()(s??[]).forEach(e=>{const u=e.sender_id===a.value?e.receiver_id:e.sender_id,o=e.document_id!==null&&e.document_id!==void 0?`document:${e.document_id}`:`users:${[a.value,u].sort().join("-")}`,r=e.receiver_id===a.value&&!e.read?1:0,n=_.get(o);n?((!n.last_message||e.created_at>n.last_message.created_at)&&(n.last_message=e),n.unread_count+=r):_.set(o,{threadKey:o,document_id:e.document_id,other_user_id:u,last_message:e,unread_count:r})});t.value=Array.from(_.values()).sort((e,u)=>(u.last_message?.created_at??"").localeCompare(e.last_message?.created_at??""));const f=[...new Set(t.value.map(e=>e.other_user_id))];if(f.length){const{data:e,error:u}=await v.from("user_profiles").select("id, avatar_url, full_name").in("id",f);if(!u&&e){const o=new Map(e.map(r=>[r.id,{avatar_url:r.avatar_url,full_name:r.full_name}]));t.value=t.value.map(r=>({...r,other_user_avatar_url:o.get(r.other_user_id)?.avatar_url??null,other_user_name:o.get(r.other_user_id)?.full_name??"UsuÃ¡rio"}))}}return d.value=!1,t.value},g=w(()=>t.value.reduce((s,l)=>s+l.unread_count,0));return{previews:t,loading:d,error:c,loadChatHistoryList:p,unreadTotal:g,setCurrentUserId:h}}export{y as u};
