var l=(t,n,o)=>new Promise((s,i)=>{var d=e=>{try{a(o.next(e))}catch(r){i(r)}},c=e=>{try{a(o.throw(e))}catch(r){i(r)}},a=e=>e.done?s(e.value):Promise.resolve(e.value).then(d,c);a((o=o.apply(t,n)).next())});import{s as f}from"./index-XXjrVMgZ.js";import"./vue-vendor-CG29anWM.js";import"./supabase-DO0Dm75k.js";function q(t){return l(this,null,function*(){var n,o;try{const s=t.status==="lost"?"found":"lost",{data:i,error:d}=yield f.from("documents").select("*").eq("type",t.type).eq("status",s).neq("user_id",t.user_id).gte("created_at",new Date(Date.now()-30*24*60*60*1e3).toISOString());if(d)throw d;if(!i||i.length===0)return[];const c=[];for(const a of i){let e=0;const r=[];if(t.document_number&&a.document_number&&t.document_number.toLowerCase()===a.document_number.toLowerCase()&&(e+=50,r.push("Número do documento coincide")),(n=t.location_metadata)!=null&&n.lat&&((o=a.location_metadata)!=null&&o.lat)){const u=p(t.location_metadata.lat,t.location_metadata.lng||0,a.location_metadata.lat,a.location_metadata.lng||0);u<5?(e+=30,r.push("Localização muito próxima")):u<20?(e+=15,r.push("Localização próxima")):u<50&&(e+=5,r.push("Mesma região"))}const h=Math.abs(new Date(t.created_at).getTime()-new Date(a.created_at).getTime())/(1e3*60*60*24);if(h<3?(e+=15,r.push("Reportado recentemente")):h<7&&(e+=10,r.push("Reportado na mesma semana")),t.title&&a.title){const u=_(t.title,a.title);u>.5&&(e+=Math.floor(u*10),r.push("Descrição similar"))}e>=20&&c.push({document:a,matchScore:e,matchReasons:r})}return c.sort((a,e)=>e.matchScore-a.matchScore),c}catch(s){return console.error("Error finding matches:",s),[]}})}function L(t,n,o){return l(this,null,function*(){try{const s=[{user_id:t.user_id,type:"match",title:"Possível Match Encontrado!",message:`Encontramos um documento ${n.type} que pode ser o seu.`,data:{documentId:n.id,matchScore:o,matchedWith:t.id},read:!1,created_at:new Date().toISOString()},{user_id:n.user_id,type:"match",title:"Possível Dono Encontrado!",message:`Alguém reportou a perda de um documento ${t.type} que pode ser o que você encontrou.`,data:{documentId:t.id,matchScore:o,matchedWith:n.id},read:!1,created_at:new Date().toISOString()}],{error:i}=yield f.from("notifications").insert(s);if(i)throw i;return{success:!0}}catch(s){return console.error("Error creating match notifications:",s),{success:!1,error:s}}})}function p(t,n,o,s){const d=m(o-t),c=m(s-n),a=Math.sin(d/2)*Math.sin(d/2)+Math.cos(m(t))*Math.cos(m(o))*Math.sin(c/2)*Math.sin(c/2);return 6371*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}function m(t){return t*(Math.PI/180)}function _(t,n){const o=new Set(t.toLowerCase().split(/\s+/)),s=new Set(n.toLowerCase().split(/\s+/)),i=new Set([...o].filter(c=>s.has(c))),d=new Set([...o,...s]);return i.size/d.size}export{q as findDocumentMatches,L as notifyMatch};
