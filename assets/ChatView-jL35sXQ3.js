import{a as A,P as K,r as p,l as O,X as z,p as F,w as R,Y as y,u as P,o as v,h as t,i as B,t as w,b as k,e as U,s as H,n as I,F as X,O as M,R as Y,j as Z,S as G,Z as J}from"./vue-vendor-BHw4onN5.js";import{s as b,u as Q,a as W,b as ee}from"./index-mP60vrJ3.js";import{u as te}from"./documents-CEbmBjEC.js";import{_ as se}from"./MainLayout.vue_vue_type_script_setup_true_lang-BUzgcg3_.js";import"./supabase-aQ0K3vAX.js";import"./logofmd-DeXnOIzE.js";const C={async fetchMessages(i,n){let r=b.from("chats").select("*").eq("document_id",i).order("created_at",{ascending:!0});n&&(r=r.or(`sender_id.eq.${n},receiver_id.eq.${n}`));const{data:o,error:u}=await r;if(u)throw u;return o||[]},async sendMessage(i){const{data:n,error:r}=await b.from("chats").insert([{...i,read:!1}]).select().single();if(r)throw r;return n},subscribeToDocument(i,n){const r=b.channel(`chats:${i}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chats",filter:`document_id=eq.${i}`},o=>{n(o.new)}).subscribe();return()=>{b.removeChannel(r)}}},ae={class:"min-h-screen bg-gray-50 dark:bg-dark-bg flex flex-col"},re={class:"bg-white dark:bg-dark-card border-b border-gray-200 dark:border-dark-border pt-safe px-4 py-3"},ne={class:"flex items-center space-x-3"},oe={class:"flex-1"},ie={class:"text-sm text-gray-500"},ce={class:"text-sm"},le={class:"text-xs opacity-70 mt-1"},de={key:0,class:"text-center py-12"},ue={class:"bg-white dark:bg-dark-card border-t border-gray-200 dark:border-dark-border p-4 pb-safe"},me=["onKeydown"],xe=A({__name:"ChatView",setup(i){const n=P(),r=K(),o=Q(),u=te(),{error:g}=W(),m=r.params.documentId,l=p(""),h=p(null),c=p([]),D=p(!1),x=p("");let f=null;const S=()=>o.userId?!0:(n.push({name:"Login",query:{redirect:r.fullPath}}),!1),q=(s,e)=>{const a=o.userId,$=s.map(d=>d.sender_id===a?d.receiver_id:d.sender_id).find(d=>d&&d!==a);return $||(e&&e!==a?e:"")},N=async()=>{if(!S())return;D.value=!0;let s="";try{s=(await u.fetchDocumentById(m))?.data?.user_id||u.currentDocument?.user_id||"",c.value=await C.fetchMessages(m,o.userId||void 0),x.value=q(c.value,s)}catch(e){g(e.message||"Erro ao carregar chat")}finally{D.value=!1}await y(),_(),E()},E=()=>{f||(f=C.subscribeToDocument(m,s=>{c.value.some(a=>a.id===s.id)||(c.value.push(s),y().then(_))}))},V=s=>`flex ${s===o.userId?"justify-end":"justify-start"}`,L=s=>{const e=s===o.userId,a="max-w-[75%] rounded-2xl px-4 py-2";return e?`${a} bg-primary text-white`:`${a} bg-white dark:bg-dark-card text-gray-900 dark:text-dark-text`},j=s=>new Date(s).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),T=async()=>{if(l.value.trim()&&S()){if(!x.value){g("Não foi possível identificar o destinatário.");return}try{const s=await C.sendMessage({document_id:m,sender_id:o.userId,receiver_id:x.value,message:l.value.trim()});c.value.push(s),l.value="",await y(),_()}catch(s){g(s.message||"Erro ao enviar mensagem")}}},_=()=>{h.value&&(h.value.scrollTop=h.value.scrollHeight)};return O(()=>{N()}),z(()=>{f&&(f(),f=null)}),(s,e)=>(v(),F(se,{"show-top-bar":!1},{default:R(()=>[t("div",ae,[t("header",re,[t("div",ne,[t("button",{class:"btn-icon",onClick:e[0]||(e[0]=a=>B(n).back())},[...e[2]||(e[2]=[t("i",{class:"fas fa-arrow-left"},null,-1)])]),t("div",oe,[e[3]||(e[3]=t("h3",{class:"font-semibold text-gray-900 dark:text-dark-text"},"Chat",-1)),t("p",ie,"Documento #"+w(B(m).slice(0,8)),1)])])]),t("div",{class:"flex-1 overflow-y-auto p-4 space-y-4",ref_key:"messagesContainer",ref:h},[(v(!0),k(X,null,H(c.value,a=>(v(),k("div",{key:a.id,class:I(V(a.sender_id))},[t("div",{class:I(L(a.sender_id))},[t("p",ce,w(a.message),1),t("p",le,w(j(a.created_at)),1)],2)],2))),128)),c.value.length===0?(v(),k("div",de,[...e[4]||(e[4]=[t("i",{class:"fas fa-comments text-gray-400 text-6xl mb-4"},null,-1),t("p",{class:"text-gray-500"},"Nenhuma mensagem ainda",-1),t("p",{class:"text-sm text-gray-400"},"Inicie a conversa!",-1)])])):U("",!0)],512),t("div",ue,[t("form",{onSubmit:M(T,["prevent"]),class:"flex items-end space-x-2"},[Y(t("textarea",{"onUpdate:modelValue":e[1]||(e[1]=a=>l.value=a),placeholder:"Digite sua mensagem...",class:"input flex-1 min-h-[44px] max-h-32 resize-none",rows:"1",onKeydown:J(M(T,["exact","prevent"]),["enter"])},null,40,me),[[G,l.value]]),Z(ee,{type:"submit",variant:"primary",disabled:!l.value.trim()},{default:R(()=>[...e[5]||(e[5]=[t("i",{class:"fas fa-paper-plane"},null,-1)])]),_:1},8,["disabled"])],32)])])]),_:1}))}});export{xe as default};
