import{r as w,c as $,a as S,l as q,C as B,p as I,w as L,o as u,h as l,b as f,e as C,i as d,t as p,s as U,F as j,u as M}from"./vue-vendor-uTGeEaNR.js";import{s as k,u as A}from"./index-DKlHRB8v.js";import{_ as D}from"./MainLayout.vue_vue_type_script_setup_true_lang-DVzd3bER.js";import{_ as E}from"./EmptyState.vue_vue_type_script_setup_true_lang-xe02qDPF.js";import"./supabase-XjigxKbv.js";import"./logofmd-DeXnOIzE.js";function F(b){const a=w(b),s=w([]),c=w(!1),m=w(null),h=o=>{a.value=o},x=async()=>{if(!a.value)return s.value=[],[];c.value=!0,m.value=null;let o=null,i=null;{const e=await k.from("chats").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});o=e.data,i=e.error}if(!o?.length){const e=await k.from("messages").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});e.data?.length&&(o=e.data,i=e.error)}if(i)return m.value=i.message,c.value=!1,[];const v=new Map()(o??[]).forEach(e=>{const t=e.sender_id===a.value?e.receiver_id:e.sender_id,_=e.document_id!==null&&e.document_id!==void 0?`document:${e.document_id}`:`users:${[a.value,t].sort().join("-")}`,n=e.receiver_id===a.value&&!e.read?1:0,g=v.get(_);g?((!g.last_message||e.created_at>g.last_message.created_at)&&(g.last_message=e),g.unread_count+=n):v.set(_,{threadKey:_,document_id:e.document_id,other_user_id:t,last_message:e,unread_count:n})});s.value=Array.from(v.values()).sort((e,t)=>(t.last_message?.created_at??"").localeCompare(e.last_message?.created_at??""));const r=[...new Set(s.value.map(e=>e.other_user_id))];if(r.length){const{data:e,error:t}=await k.from("user_profiles").select("id, avatar_url, full_name").in("id",r);if(!t&&e){const _=new Map(e.map(n=>[n.id,{avatar_url:n.avatar_url,full_name:n.full_name}]));s.value=s.value.map(n=>({...n,other_user_avatar_url:_.get(n.other_user_id)?.avatar_url??null,other_user_name:_.get(n.other_user_id)?.full_name??"Usuário"}))}}return c.value=!1,s.value},y=$(()=>s.value.reduce((o,i)=>o+i.unread_count,0));return{previews:s,loading:c,error:m,loadChatHistoryList:x,unreadTotal:y,setCurrentUserId:h}}const K={class:"max-w-3xl mx-auto px-4 py-6 space-y-4"},N={class:"flex items-center justify-between"},V={key:0,class:"text-sm text-primary"},H={key:0,class:"text-gray-500"},R={key:1,class:"text-red-500"},T={class:"space-y-3"},z=["onClick"],G=["src"],J={class:"flex-1 overflow-hidden"},O={class:"font-semibold truncate"},P={class:"text-sm text-gray-600 dark:text-gray-300 truncate"},Q={class:"text-right shrink-0"},W={class:"text-xs text-gray-400"},X={key:0,class:"ml-auto mt-1 inline-flex min-w-6 justify-center rounded-full bg-primary px-2 py-1 text-xs font-semibold text-white"},re=S({__name:"ChatListView",setup(b){const a=M(),s=A(),{previews:c,loading:m,error:h,loadChatHistoryList:x,unreadTotal:y,setCurrentUserId:o}=F(s.userId||""),i=r=>{r.document_id?a.push({name:"Chat",params:{documentId:r.document_id}}):a.push({name:"Chat",params:{documentId:r.threadKey.replace("users:","")}})},v=r=>new Date(r).toLocaleString("pt-BR",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"});return q(()=>{s.userId&&x()}),B(()=>s.userId,r=>{r?(o(r),x()):o("")}),(r,e)=>(u(),I(D,{"notification-count":0},{default:L(()=>[l("section",K,[l("header",N,[e[0]||(e[0]=l("h1",{class:"text-2xl font-semibold"},"Conversas",-1)),d(y)?(u(),f("span",V,p(d(y))+" não lidas ",1)):C("",!0)]),d(m)?(u(),f("div",H,"Carregando conversas...")):d(h)?(u(),f("div",R,p(d(h)),1)):C("",!0),l("ul",T,[(u(!0),f(j,null,U(d(c),t=>(u(),f("li",{key:t.threadKey,class:"flex items-center gap-3 rounded-lg border border-gray-200 dark:border-dark-border bg-white dark:bg-dark-card p-3 shadow-sm cursor-pointer",onClick:_=>i(t)},[l("img",{src:t.other_user_avatar_url||"https://placehold.co/64x64",alt:"Avatar",class:"h-12 w-12 rounded-full object-cover"},null,8,G),l("div",J,[l("p",O,p(t.other_user_name||"Contato"),1),l("p",P,p(t.last_message?.message||"Sem mensagens"),1)]),l("div",Q,[l("p",W,p(t.last_message?v(t.last_message.created_at):""),1),t.unread_count?(u(),f("span",X,p(t.unread_count),1)):C("",!0)])],8,z))),128))]),!d(m)&&!d(h)&&d(c).length===0?(u(),I(E,{key:2,title:"Nenhuma conversa",description:"Inicie uma nova conversa a partir de um documento."})):C("",!0)])]),_:1}))}});export{re as default};
