import{r as w,c as I,a as q,l as L,C as B,p as b,w as M,o as c,h as l,b as f,e as C,t as i,i as d,s as S,F as U,u as j}from"./vue-vendor-BHw4onN5.js";import{s as k,u as D}from"./index-BUR5dxbQ.js";import{_ as A}from"./MainLayout.vue_vue_type_script_setup_true_lang-C8o4x7wP.js";import{_ as E}from"./EmptyState.vue_vue_type_script_setup_true_lang-BI1vsBuq.js";import"./supabase-aQ0K3vAX.js";import"./logofmd-DeXnOIzE.js";function F($){const s=w($),r=w([]),_=w(!1),h=w(null),p=o=>{s.value=o},y=async()=>{if(!s.value)return r.value=[],[];_.value=!0,h.value=null,console.log("[useChat] Loading chat history for user:",s.value);let o=null,u=null;{const e=await k.from("chats").select("*").or(`sender_id.eq.${s.value},receiver_id.eq.${s.value}`).order("created_at",{ascending:!1});console.log("[useChat] Chats query result:",{data:e.data,error:e.error}),o=e.data,u=e.error}if(!o?.length){const e=await k.from("messages").select("*").or(`sender_id.eq.${s.value},receiver_id.eq.${s.value}`).order("created_at",{ascending:!1});e.data?.length&&(o=e.data,u=e.error)}if(u)return h.value=u.message,_.value=!1,[];const v=new Map()(o??[]).forEach(e=>{const a=e.sender_id===s.value?e.receiver_id:e.sender_id,m=e.document_id!==null&&e.document_id!==void 0?`document:${e.document_id}`:`users:${[s.value,a].sort().join("-")}`,n=e.receiver_id===s.value&&!e.read?1:0,g=v.get(m);g?((!g.last_message||e.created_at>g.last_message.created_at)&&(g.last_message=e),g.unread_count+=n):v.set(m,{threadKey:m,document_id:e.document_id,other_user_id:a,last_message:e,unread_count:n})});r.value=Array.from(v.values()).sort((e,a)=>(a.last_message?.created_at??"").localeCompare(e.last_message?.created_at??""));const t=[...new Set(r.value.map(e=>e.other_user_id))];if(t.length){const{data:e,error:a}=await k.from("user_profiles").select("id, avatar_url, full_name").in("id",t);if(!a&&e){const m=new Map(e.map(n=>[n.id,{avatar_url:n.avatar_url,full_name:n.full_name}]));r.value=r.value.map(n=>({...n,other_user_avatar_url:m.get(n.other_user_id)?.avatar_url??null,other_user_name:m.get(n.other_user_id)?.full_name??"UsuÃ¡rio"}))}}return _.value=!1,r.value},x=I(()=>r.value.reduce((o,u)=>o+u.unread_count,0));return{previews:r,loading:_,error:h,loadChatHistoryList:y,unreadTotal:x,setCurrentUserId:p}}const K={class:"max-w-3xl mx-auto px-4 py-6 space-y-4"},V={class:"flex items-center justify-between"},H={class:"text-2xl font-semibold"},N={key:0,class:"text-sm text-primary"},R={key:0,class:"text-gray-500"},T={key:1,class:"text-red-500"},z={class:"space-y-3"},G=["onClick"],J=["src"],O={class:"flex-1 overflow-hidden"},P={class:"font-semibold truncate"},Q={class:"text-sm text-gray-600 dark:text-gray-300 truncate"},W={class:"text-right shrink-0"},X={class:"text-xs text-gray-400"},Y={key:0,class:"ml-auto mt-1 inline-flex min-w-6 justify-center rounded-full bg-primary px-2 py-1 text-xs font-semibold text-white"},oe=q({__name:"ChatListView",setup($){const s=j(),r=D(),{previews:_,loading:h,error:p,loadChatHistoryList:y,unreadTotal:x,setCurrentUserId:o}=F(r.userId||""),u=t=>{t.document_id?s.push({name:"Chat",params:{documentId:t.document_id}}):s.push({name:"Chat",params:{documentId:t.threadKey.replace("users:","")}})},v=t=>new Date(t).toLocaleString("pt-BR",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"});return L(()=>{r.userId&&y()}),B(()=>r.userId,t=>{t?(o(t),y()):o("")}),(t,e)=>(c(),b(A,{"notification-count":0},{default:M(()=>[l("section",K,[l("header",V,[l("h1",H,i(t.$t("chat.title")),1),d(x)?(c(),f("span",N,i(d(x))+" "+i(t.$t("chat.unread")),1)):C("",!0)]),d(h)?(c(),f("div",R,i(t.$t("chat.loading")),1)):d(p)?(c(),f("div",T,i(d(p)),1)):C("",!0),l("ul",z,[(c(!0),f(U,null,S(d(_),a=>(c(),f("li",{key:a.threadKey,class:"flex items-center gap-3 rounded-lg border border-gray-200 dark:border-dark-border bg-white dark:bg-dark-card p-3 shadow-sm cursor-pointer",onClick:m=>u(a)},[l("img",{src:a.other_user_avatar_url||"https://placehold.co/64x64",alt:"Avatar",class:"h-12 w-12 rounded-full object-cover"},null,8,J),l("div",O,[l("p",P,i(a.other_user_name||t.$t("chat.contact")),1),l("p",Q,i(a.last_message?.message||t.$t("chat.noMessages")),1)]),l("div",W,[l("p",X,i(a.last_message?v(a.last_message.created_at):""),1),a.unread_count?(c(),f("span",Y,i(a.unread_count),1)):C("",!0)])],8,G))),128))]),!d(h)&&!d(p)&&d(_).length===0?(c(),b(E,{key:2,title:t.$t("chat.empty"),description:t.$t("chat.emptyDescription")},null,8,["title","description"])):C("",!0)])]),_:1}))}});export{oe as default};
