const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/documentMatching-CS_ZrdA9.js","assets/index-BBvWYsGI.js","assets/vue-vendor-DJ0JNZJp.js","assets/supabase-aQ0K3vAX.js","assets/index-BDxEkXho.css"])))=>i.map(i=>d[i]);
import{s as n,f as N}from"./index-BBvWYsGI.js";import{d as A,r as v,c as E}from"./vue-vendor-DJ0JNZJp.js";const O=A("documents",()=>{const a=v([]),c=v(null),l=v(!1),u=v(null),m=v(!0),h=v(0),_=20,w=E(()=>a.value.filter(r=>r.status==="lost")),b=E(()=>a.value.filter(r=>r.status==="found"));async function S(r=!1){if(r&&(h.value=0,a.value=[],m.value=!0),!m.value&&!r)return{success:!0};l.value=!0,u.value=null;try{const e=h.value*_,t=e+_-1,{data:s,error:i}=await n.from("documents").select("*").in("status",["lost","found"]).eq("is_public",!0).order("created_at",{ascending:!1}).range(e,t);if(i)throw i;return s&&(r?a.value=s:a.value.push(...s),m.value=s.length===_,s.length>0&&h.value++),{success:!0}}catch(e){return u.value=e.message||"Erro ao carregar documentos",{success:!1,error:u.value}}finally{l.value=!1}}async function q(r,e=!1){e&&(a.value=[]),l.value=!0,u.value=null;try{const{data:t,error:s}=await n.from("documents").select("*").eq("user_id",r).order("created_at",{ascending:!1});if(s)throw s;return t&&(a.value=t),{success:!0}}catch(t){return u.value=t.message||"Erro ao carregar documentos",{success:!1,error:u.value}}finally{l.value=!1}}async function x(r){l.value=!0,u.value=null;try{const{data:e,error:t}=await n.from("documents").select("*").eq("id",r).single();if(t)throw t;return e&&(c.value=e),{success:!0,data:e}}catch(e){return u.value=e.message||"Erro ao carregar documento",{success:!1,error:u.value}}finally{l.value=!1}}async function M(r,e){l.value=!0,u.value=null;try{let t="",s="";if(e.file){const p=e.file.name.split(".").pop();s=`documents/${`${r}_${Date.now()}.${p}`}`;const{error:f}=await n.storage.from("documents").upload(s,e.file,{cacheControl:"3600",upsert:!1});if(f)throw console.error("Storage upload error:",f),new Error(`Erro ao fazer upload do arquivo: ${f.message}. Verifique se o bucket 'documents' estÃ¡ criado no Supabase Storage.`);const{data:d}=n.storage.from("documents").getPublicUrl(s);t=d.publicUrl}const i={user_id:r,title:e.title,type:e.type,status:e.status,description:e.description||"",location:e.location||"",location_metadata:e.locationMetadata||null,meeting_point_metadata:e.meetingPointMetadata||null,document_number:e.documentNumber||"",issue_date:e.issueDate||null,expiry_date:e.expiryDate||null,issue_place:e.issuePlace||"",issuing_authority:e.issuingAuthority||"",country_of_issue:e.countryOfIssue||"",file_url:t,file_path:s,file_name:e.file?.name||"",file_size:e.file?.size||null,file_type:e.file?.type||"",is_verified:!1,verification_status:"pending",is_public:!0,is_archived:!1},{data:o,error:y}=await n.from("documents").insert([i]).select().single();if(y)throw y;return o&&(a.value.unshift(o),(o.status==="lost"||o.status==="found")&&N(async()=>{const{findDocumentMatches:p,notifyMatch:g}=await import("./documentMatching-CS_ZrdA9.js");return{findDocumentMatches:p,notifyMatch:g}},__vite__mapDeps([0,1,2,3,4])).then(({findDocumentMatches:p,notifyMatch:g})=>{p(o).then(f=>{if(f.length>0){const d=f[0];if(d.matchScore>=50){const U=o.status==="lost"?o:d.document,I=o.status==="found"?o:d.document;g(U,I,d.matchScore)}}})})),{success:!0,data:o}}catch(t){return u.value=t.message||"Erro ao criar documento",{success:!1,error:u.value}}finally{l.value=!1}}async function P(r,e){l.value=!0,u.value=null;try{const{data:t,error:s}=await n.from("documents").update(e).eq("id",r).select().single();if(s)throw s;if(t){const i=a.value.findIndex(o=>o.id===r);i!==-1&&(a.value[i]=t),c.value?.id===r&&(c.value=t)}return{success:!0,data:t}}catch(t){return u.value=t.message||"Erro ao atualizar documento",{success:!1,error:u.value}}finally{l.value=!1}}async function z(r){l.value=!0,u.value=null;try{const{error:e}=await n.from("documents").delete().eq("id",r);if(e)throw e;return a.value=a.value.filter(t=>t.id!==r),c.value?.id===r&&(c.value=null),{success:!0}}catch(e){return u.value=e.message||"Erro ao deletar documento",{success:!1,error:u.value}}finally{l.value=!1}}function $(){a.value=[],c.value=null,h.value=0,m.value=!0}return{documents:a,currentDocument:c,isLoading:l,error:u,hasMore:m,lostDocuments:w,foundDocuments:b,fetchDocuments:S,fetchUserDocuments:q,fetchDocumentById:x,createDocument:M,updateDocument:P,deleteDocument:z,clearDocuments:$}});export{O as u};
