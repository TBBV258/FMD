import{a as te,r as w,c as h,l as se,C as H,Y as ae,p as re,w as ne,u as oe,o as l,h as s,b as d,e as p,t as i,k as N,n as g,i as x,F as C,s as K,O as ie}from"./vue-vendor-DJ0JNZJp.js";import{s as v,u as le,c as de,a as ce}from"./index-BkTEcezC.js";import{u as ue}from"./useChat-1OHSimpg.js";import{_ as me}from"./MainLayout.vue_vue_type_script_setup_true_lang-CCdKNcrq.js";import"./supabase-aQ0K3vAX.js";import"./logofmd-DeXnOIzE.js";const $={async fetch(u){const{data:n,error:o}=await v.from("notifications").select("*").eq("user_id",u).order("created_at",{ascending:!1});if(o)throw o;return(n||[]).map(r=>({...r,read:r.read||r.is_read||!1,is_read:r.is_read||r.read||!1,data:r.data||r.metadata||null,metadata:r.metadata||r.data||null}))},async markAsRead(u){const{data:n,error:o}=await v.from("notifications").update({read:!0,is_read:!0,read_at:new Date().toISOString()}).eq("id",u).select().single();if(o)throw o;return{...n,read:!0,is_read:!0,data:n.metadata||n.data||null,metadata:n.metadata||n.data||null}},async markAllAsRead(u){const{error:n}=await v.from("notifications").update({read:!0,is_read:!0,read_at:new Date().toISOString()}).eq("user_id",u).or("read.eq.false,is_read.eq.false");if(n)throw n;return!0},subscribeToUser(u,n){const o=v.channel(`notifications:${u}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${u}`},r=>{const c=r.new;n({...c,read:c.read||c.is_read||!1,is_read:c.is_read||c.read||!1,data:c.data||c.metadata||null,metadata:c.metadata||c.data||null})}).subscribe();return()=>{v.removeChannel(o)}}},fe={class:"px-4 py-6 space-y-6"},he={class:"flex items-center justify-between"},ye={class:"text-2xl font-bold text-gray-900 dark:text-dark-text"},_e=["disabled"],pe={class:"flex rounded-full bg-gray-100 dark:bg-dark-card p-1"},ge={key:0,class:"ml-2 px-2 py-0.5 text-xs bg-primary text-white rounded-full"},xe={key:0,class:"ml-2 px-2 py-0.5 text-xs bg-primary text-white rounded-full"},ve={key:0,class:"text-center py-12"},be={class:"text-gray-500"},ke={key:1,class:"text-center py-12 card"},we={class:"text-red-500"},Ce={key:2,class:"text-center py-12 card"},$e={class:"text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2"},Ie={class:"text-gray-500 dark:text-gray-400"},Ae={key:3,class:"space-y-3"},Re=["onClick"],Se={class:"flex items-start space-x-3"},Ne=["src"],Te={class:"flex-1 min-w-0"},Me={class:"font-semibold text-gray-900 dark:text-dark-text mb-1"},je={class:"text-sm text-gray-600 dark:text-gray-400 mb-1 truncate"},Ee={class:"text-xs text-gray-500"},qe={class:"flex flex-col items-end"},De={key:0,class:"inline-flex min-w-6 justify-center rounded-full bg-primary px-2 py-1 text-xs font-semibold text-white mb-1"},Be={key:0,class:"text-center py-12 card"},Le={class:"text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2"},Ue={class:"text-gray-500 dark:text-gray-400"},Ve={key:1,class:"space-y-3"},Oe=["onClick"],Fe={class:"flex items-start space-x-3"},He={class:"flex-1 min-w-0"},Ke={class:"font-semibold text-gray-900 dark:text-dark-text mb-1"},Pe={class:"text-sm text-gray-600 dark:text-gray-400 mb-2"},ze={class:"text-xs text-gray-500"},Ye=["onClick"],et=te({__name:"NotificationsView",setup(u){const n=oe(),o=le(),{t:r}=de(),{error:c}=ce(),m=w("all"),f=w([]),T=w(!1),y=w(!1);let _=null;const{previews:M,loading:P,error:j,loadChatHistoryList:I,unreadTotal:E,setCurrentUserId:A}=ue(o.userId||""),z=h(()=>f.value),q=h(()=>f.value.filter(e=>e.type==="message")),D=h(()=>m.value==="all"?z.value:q.value),R=h(()=>f.value.filter(e=>!e.read&&!e.is_read).length),B=h(()=>m.value==="chats"&&E.value>0?E.value:q.value.filter(e=>!e.read&&!e.is_read).length),L=h(()=>m.value==="chats"?{title:r("notifications.emptyChats"),subtitle:r("notifications.emptyChatsSubtitle")}:{title:r("notifications.empty"),subtitle:r("notifications.emptySubtitle")}),Y=e=>e.read||e.is_read?"opacity-60":"bg-primary/5",U=e=>{const t="flex-1 py-2 rounded-full text-sm font-semibold transition-colors";return m.value===e?`${t} bg-white dark:bg-dark-bg text-primary shadow`:`${t} text-gray-500`},G=e=>{const t={document_match:"w-10 h-10 rounded-full bg-success/10 text-success flex items-center justify-center",document_found:"w-10 h-10 rounded-full bg-success/10 text-success flex items-center justify-center",message:"w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center",system:"w-10 h-10 rounded-full bg-gray-100 dark:bg-dark-card text-gray-600 dark:text-gray-400 flex items-center justify-center",verification:"w-10 h-10 rounded-full bg-warning/10 text-warning-dark flex items-center justify-center"};return t[e]||t.system},J=e=>({document_match:"fas fa-check-double",document_found:"fas fa-search",message:"fas fa-envelope",system:"fas fa-info-circle",verification:"fas fa-shield-alt"})[e]||"fas fa-bell",V=e=>{const t=new Date,a=new Date(e),b=t.getTime()-a.getTime(),k=Math.floor(b/6e4),S=Math.floor(k/60),F=Math.floor(S/24);return k<1?r("notifications.timeAgo.now"):k<60?r("notifications.timeAgo.minutes",{n:k}):S<24?r("notifications.timeAgo.hours",{n:S}):F<7?r("notifications.timeAgo.days",{n:F}):a.toLocaleDateString("pt-BR",{day:"2-digit",month:"short"})},Q=async()=>{if(!o.userId){n.push({name:"Login",query:{redirect:n.currentRoute.value.fullPath}});return}T.value=!0;try{f.value=await $.fetch(o.userId)}catch(e){c(e.message||r("notifications.loadingError"))}finally{T.value=!1}},W=()=>{!o.userId||_||(_=$.subscribeToUser(o.userId,e=>{f.value=[e,...f.value]}))},X=e=>{e.document_id?n.push({name:"Chat",params:{documentId:e.document_id}}):n.push({name:"Chat",params:{documentId:e.threadKey.replace("users:","")}})},Z=async e=>{if(await O(e.id),e.action_url){n.push(e.action_url);return}const t=e.metadata||e.data;t&&((e.type==="document_match"||e.type==="document_found")&&"documentId"in t?n.push(`/document/${t.documentId}`):e.type==="message"&&"document_id"in t?n.push(`/chat/${t.document_id}`):e.type==="verification"&&"documentId"in t?n.push(`/document/${t.documentId}`):e.type==="document_status_change"&&"documentId"in t&&n.push(`/document/${t.documentId}`))},O=async e=>{const t=f.value.find(a=>a.id===e);if(!(!t||t.read||t.is_read)){t.read=!0,t.is_read=!0;try{await $.markAsRead(e)}catch(a){c(a.message||r("notifications.updateError")),t.read=!1,t.is_read=!1}}},ee=async()=>{if(!(!o.userId||y.value)){y.value=!0;try{await $.markAllAsRead(o.userId),f.value.forEach(e=>{e.read=!0,e.is_read=!0})}catch(e){c(e.message||r("notifications.markAllError"))}finally{y.value=!1}}};return se(async()=>{await Q(),W(),o.userId&&(A(o.userId),await I())}),H(m,e=>{e==="chats"&&o.userId&&I()}),H(()=>o.userId,e=>{e?(A(e),I()):A("")}),ae(()=>{_&&(_(),_=null)}),(e,t)=>(l(),re(me,null,{default:ne(()=>[s("div",fe,[s("div",he,[s("h1",ye,i(e.$t("notifications.title")),1),R.value>0?(l(),d("button",{key:0,onClick:ee,class:"text-sm text-primary hover:text-primary-dark font-medium transition-colors",disabled:y.value},[t[2]||(t[2]=s("i",{class:"fas fa-check-double mr-1"},null,-1)),N(" "+i(y.value?e.$t("notifications.marking"):e.$t("notifications.markAllRead")),1)],8,_e)):p("",!0)]),s("div",pe,[s("button",{class:g(U("all")),onClick:t[0]||(t[0]=a=>m.value="all")},[N(i(e.$t("notifications.tabs.all"))+" ",1),R.value>0?(l(),d("span",ge,i(R.value),1)):p("",!0)],2),s("button",{class:g(U("chats")),onClick:t[1]||(t[1]=a=>m.value="chats")},[N(i(e.$t("notifications.tabs.chats"))+" ",1),B.value>0?(l(),d("span",xe,i(B.value),1)):p("",!0)],2)]),m.value==="chats"?(l(),d(C,{key:0},[x(P)?(l(),d("div",ve,[t[3]||(t[3]=s("div",{class:"spinner mx-auto mb-4"},null,-1)),s("p",be,i(e.$t("chat.loading")),1)])):x(j)?(l(),d("div",ke,[t[4]||(t[4]=s("i",{class:"fas fa-exclamation-triangle text-red-400 text-6xl mb-4"},null,-1)),s("p",we,i(x(j)),1)])):x(M).length===0?(l(),d("div",Ce,[t[5]||(t[5]=s("i",{class:"fas fa-comments text-gray-400 text-6xl mb-4"},null,-1)),s("h3",$e,i(e.$t("notifications.emptyChats")),1),s("p",Ie,i(e.$t("notifications.emptyChatsSubtitle")),1)])):(l(),d("div",Ae,[(l(!0),d(C,null,K(x(M),a=>(l(),d("div",{key:a.threadKey,class:"card card-hover",onClick:b=>X(a)},[s("div",Se,[s("img",{src:a.other_user_avatar_url||"https://placehold.co/64x64",alt:"Avatar",class:"h-12 w-12 rounded-full object-cover"},null,8,Ne),s("div",Te,[s("h4",Me,i(a.other_user_name||e.$t("chat.contact")),1),s("p",je,i(a.last_message?.message||e.$t("chat.noMessages")),1),s("p",Ee,i(a.last_message?V(a.last_message.created_at):""),1)]),s("div",qe,[a.unread_count>0?(l(),d("span",De,i(a.unread_count),1)):p("",!0),t[6]||(t[6]=s("i",{class:"fas fa-chevron-right text-gray-400"},null,-1))])])],8,Re))),128))]))],64)):(l(),d(C,{key:1},[D.value.length===0?(l(),d("div",Be,[t[7]||(t[7]=s("i",{class:"fas fa-bell-slash text-gray-400 text-6xl mb-4"},null,-1)),s("h3",Le,i(L.value.title),1),s("p",Ue,i(L.value.subtitle),1)])):(l(),d("div",Ve,[(l(!0),d(C,null,K(D.value,a=>(l(),d("div",{key:a.id,class:g([Y(a),"card card-hover"]),onClick:b=>Z(a)},[s("div",Fe,[s("div",{class:g(G(a.type))},[s("i",{class:g(J(a.type))},null,2)],2),s("div",He,[s("h4",Ke,i(a.title),1),s("p",Pe,i(a.message),1),s("p",ze,i(V(a.created_at)),1)]),!a.read&&!a.is_read?(l(),d("button",{key:0,class:"w-2 h-2 rounded-full bg-primary",onClick:ie(b=>O(a.id),["stop"])},null,8,Ye)):p("",!0)])],10,Oe))),128))]))],64))])]),_:1}))}});export{et as default};
