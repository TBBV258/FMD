var c=(l,o,a)=>new Promise((u,k)=>{var f=n=>{try{y(a.next(n))}catch(p){k(p)}},i=n=>{try{y(a.throw(n))}catch(p){k(p)}},y=n=>n.done?u(n.value):Promise.resolve(n.value).then(f,i);y((a=a.apply(l,o)).next())});import{a as z,r as I,c as x,l as F,X as H,p as P,w as Q,u as X,o as d,h as r,b as m,e as N,n as v,k as G,t as g,F as J,s as K,O as W}from"./vue-vendor-D3gglZhg.js";import{u as Y,a as Z}from"./index-DVvGwCfe.js";import{s as b}from"./supabase-BWysbwwl.js";import{_ as ee}from"./MainLayout.vue_vue_type_script_setup_true_lang-po6AB_6N.js";import"./supabase-BZLovRLP.js";import"./logofmd-DIbmBIad.js";const C={fetch(l){return c(this,null,function*(){const{data:o,error:a}=yield b.from("notifications").select("*").eq("user_id",l).order("created_at",{ascending:!1});if(a)throw a;return o||[]})},markAsRead(l){return c(this,null,function*(){const{data:o,error:a}=yield b.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",l).select().single();if(a)throw a;return o})},markAllAsRead(l){return c(this,null,function*(){const{data:o,error:a}=yield b.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",l).eq("is_read",!1).select();if(a)throw a;return o})},subscribeToUser(l,o){const a=b.channel(`notifications:${l}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${l}`},u=>{o(u.new)}).subscribe();return()=>{b.removeChannel(a)}}},te={class:"px-4 py-6 space-y-6"},ae={class:"flex items-center justify-between"},se={class:"flex rounded-full bg-gray-100 dark:bg-dark-card p-1"},re={key:0,class:"ml-1 text-xs"},oe={key:0,class:"text-center py-12 card"},ne={class:"text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2"},le={class:"text-gray-500 dark:text-gray-400"},ie={key:1,class:"space-y-3"},ce=["onClick"],de={class:"flex items-start space-x-3"},ue={class:"flex-1 min-w-0"},fe={class:"font-semibold text-gray-900 dark:text-dark-text mb-1"},me={class:"text-sm text-gray-600 dark:text-gray-400 mb-2"},ye={class:"text-xs text-gray-500"},he=["onClick"],we=z({__name:"NotificationsView",setup(l){const o=X(),a=Y(),{error:u,success:k}=Z(),f=I("all"),i=I([]),y=I(!1);let n=null;const p=x(()=>i.value),q=x(()=>i.value.filter(e=>e.type==="message")),A=x(()=>f.value==="all"?p.value:q.value),_=x(()=>i.value.filter(e=>!e.read).length),S=x(()=>f.value==="chats"?{title:"Sem conversas",subtitle:"Quando alguém enviar uma mensagem, ela aparecerá aqui."}:{title:"Sem notificações",subtitle:"Você está em dia!"}),D=e=>e?"opacity-60":"",R=e=>{const t="flex-1 py-2 rounded-full text-sm font-semibold transition-colors";return f.value===e?`${t} bg-white dark:bg-dark-bg text-primary shadow`:`${t} text-gray-500`},E=e=>{const t={match:"w-10 h-10 rounded-full bg-success/10 text-success flex items-center justify-center",message:"w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center",system:"w-10 h-10 rounded-full bg-gray-100 dark:bg-dark-card text-gray-600 dark:text-gray-400 flex items-center justify-center",verification:"w-10 h-10 rounded-full bg-warning/10 text-warning-dark flex items-center justify-center"};return t[e]||t.system},B=e=>({match:"fas fa-check-double",message:"fas fa-envelope",system:"fas fa-info-circle",verification:"fas fa-shield-alt"})[e]||"fas fa-bell",j=e=>{const t=new Date,s=new Date(e),h=t.getTime()-s.getTime(),w=Math.floor(h/6e4),$=Math.floor(w/60),M=Math.floor($/24);return w<1?"Agora":w<60?`${w}m atrás`:$<24?`${$}h atrás`:M<7?`${M}d atrás`:s.toLocaleDateString("pt-BR",{day:"2-digit",month:"short"})},V=()=>c(this,null,function*(){if(!a.userId){o.push({name:"Login",query:{redirect:o.currentRoute.value.fullPath}});return}y.value=!0;try{i.value=yield C.fetch(a.userId)}catch(e){u(e.message||"Erro ao carregar notificações")}finally{y.value=!1}}),L=()=>{!a.userId||n||(n=C.subscribeToUser(a.userId,e=>{i.value=[e,...i.value]}))},O=e=>c(this,null,function*(){var t,s,h;yield T(e.id),e.type==="match"&&((t=e.data)!=null&&t.documentId)?o.push(`/document/${e.data.documentId}`):e.type==="message"&&((s=e.data)!=null&&s.documentId)?o.push(`/chat/${e.data.documentId}`):e.type==="verification"&&((h=e.data)!=null&&h.documentId)&&o.push(`/document/${e.data.documentId}`)}),T=e=>c(this,null,function*(){const t=i.value.find(s=>s.id===e);if(!(!t||t.read)){t.read=!0;try{yield C.markAsRead(e)}catch(s){u(s.message||"Erro ao atualizar notificação"),t.read=!1}}}),U=()=>c(this,null,function*(){if(!(!a.userId||_.value===0))try{yield C.markAllAsRead(a.userId),i.value.forEach(e=>{e.read=!0}),k("Todas as notificações foram marcadas como lidas!")}catch(e){u(e.message||"Erro ao marcar todas como lidas")}});return F(()=>c(this,null,function*(){yield V(),L()})),H(()=>{n&&(n(),n=null)}),(e,t)=>(d(),P(ee,null,{default:Q(()=>[r("div",te,[r("div",ae,[t[2]||(t[2]=r("h1",{class:"text-2xl font-bold text-gray-900 dark:text-dark-text"},"Notificações",-1)),_.value>0?(d(),m("button",{key:0,class:"text-sm text-primary font-medium",onClick:U}," Marcar todas como lidas ")):N("",!0)]),r("div",se,[r("button",{class:v(R("all")),onClick:t[0]||(t[0]=s=>f.value="all")},[t[3]||(t[3]=G(" Notificações ",-1)),_.value>0?(d(),m("span",re,"("+g(_.value)+")",1)):N("",!0)],2),r("button",{class:v(R("chats")),onClick:t[1]||(t[1]=s=>f.value="chats")}," Conversas ",2)]),A.value.length===0?(d(),m("div",oe,[t[4]||(t[4]=r("i",{class:"fas fa-bell-slash text-gray-400 text-6xl mb-4"},null,-1)),r("h3",ne,g(S.value.title),1),r("p",le,g(S.value.subtitle),1)])):(d(),m("div",ie,[(d(!0),m(J,null,K(A.value,s=>(d(),m("div",{key:s.id,class:v([D(s.read),"card card-hover"]),onClick:h=>O(s)},[r("div",de,[r("div",{class:v(E(s.type))},[r("i",{class:v(B(s.type))},null,2)],2),r("div",ue,[r("h4",fe,g(s.title),1),r("p",me,g(s.message),1),r("p",ye,g(j(s.created_at)),1)]),s.read?N("",!0):(d(),m("button",{key:0,class:"btn-icon text-primary",onClick:W(h=>T(s.id),["stop"]),title:"Marcar como lida"},[...t[5]||(t[5]=[r("i",{class:"fas fa-check"},null,-1)])],8,he))])],10,ce))),128))]))])]),_:1}))}});export{we as default};
