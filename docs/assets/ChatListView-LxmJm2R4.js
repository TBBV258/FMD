var D=Object.defineProperty,E=Object.defineProperties;var F=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable;var L=(s,a,t)=>a in s?D(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t,U=(s,a)=>{for(var t in a||(a={}))K.call(a,t)&&L(s,t,a[t]);if(B)for(var t of B(a))N.call(a,t)&&L(s,t,a[t]);return s},j=(s,a)=>E(s,F(a));var M=(s,a,t)=>new Promise((c,_)=>{var v=r=>{try{p(t.next(r))}catch(n){_(n)}},g=r=>{try{p(t.throw(r))}catch(n){_(n)}},p=r=>r.done?c(r.value):Promise.resolve(r.value).then(v,g);p((t=t.apply(s,a)).next())});import{r as b,c as V,a as H,l as R,C as T,p as A,w as z,o as h,h as u,b as x,e as I,i as f,t as y,s as G,F as J,u as O}from"./vue-vendor-CG29anWM.js";import{s as $,u as P}from"./index-BJKRiKdG.js";import{_ as Q}from"./MainLayout.vue_vue_type_script_setup_true_lang-wYdRj66s.js";import{_ as W}from"./EmptyState.vue_vue_type_script_setup_true_lang-CXps6QQ_.js";import"./supabase-DO0Dm75k.js";import"./logofmd-DIbmBIad.js";function X(s){const a=b(s),t=b([]),c=b(!1),_=b(null),v=r=>{a.value=r},g=()=>M(this,null,function*(){var C;if(!a.value)return t.value=[],[];c.value=!0,_.value=null;let r=null,n=null;{const e=yield $.from("chats").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});r=e.data,n=e.error}if(!(r!=null&&r.length)){const e=yield $.from("messages").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});(C=e.data)!=null&&C.length&&(r=e.data,n=e.error)}if(n)return _.value=n.message,c.value=!1,[];const w=new Map()(r!=null?r:[]).forEach(e=>{const m=e.sender_id===a.value?e.receiver_id:e.sender_id,i=e.document_id!==null&&e.document_id!==void 0?`document:${e.document_id}`:`users:${[a.value,m].sort().join("-")}`,o=e.receiver_id===a.value&&!e.read?1:0,d=w.get(i);d?((!d.last_message||e.created_at>d.last_message.created_at)&&(d.last_message=e),d.unread_count+=o):w.set(i,{threadKey:i,document_id:e.document_id,other_user_id:m,last_message:e,unread_count:o})});t.value=Array.from(w.values()).sort((e,m)=>{var i,o,d,k;return((o=(i=m.last_message)==null?void 0:i.created_at)!=null?o:"").localeCompare((k=(d=e.last_message)==null?void 0:d.created_at)!=null?k:"")});const l=[...new Set(t.value.map(e=>e.other_user_id))];if(l.length){const{data:e,error:m}=yield $.from("profiles").select("id, avatar_url, full_name").in("id",l);if(!m&&e){const i=new Map(e.map(o=>[o.id,{avatar_url:o.avatar_url,full_name:o.full_name}]));t.value=t.value.map(o=>{var d,k,S,q;return j(U({},o),{other_user_avatar_url:(k=(d=i.get(o.other_user_id))==null?void 0:d.avatar_url)!=null?k:null,other_user_name:(q=(S=i.get(o.other_user_id))==null?void 0:S.full_name)!=null?q:"Usuário"})})}}return c.value=!1,t.value}),p=V(()=>t.value.reduce((r,n)=>r+n.unread_count,0));return{previews:t,loading:c,error:_,loadChatHistoryList:g,unreadTotal:p,setCurrentUserId:v}}const Y={class:"max-w-3xl mx-auto px-4 py-6 space-y-4"},Z={class:"flex items-center justify-between"},ee={key:0,class:"text-sm text-primary"},te={key:0,class:"text-gray-500"},ae={key:1,class:"text-red-500"},re={class:"space-y-3"},se=["onClick"],oe=["src"],ne={class:"flex-1 overflow-hidden"},le={class:"font-semibold truncate"},de={class:"text-sm text-gray-600 dark:text-gray-300 truncate"},ie={class:"text-right shrink-0"},ue={class:"text-xs text-gray-400"},ce={key:0,class:"ml-auto mt-1 inline-flex min-w-6 justify-center rounded-full bg-primary px-2 py-1 text-xs font-semibold text-white"},xe=H({__name:"ChatListView",setup(s){const a=O(),t=P(),{previews:c,loading:_,error:v,loadChatHistoryList:g,unreadTotal:p,setCurrentUserId:r}=X(t.userId||""),n=l=>{l.document_id?a.push({name:"Chat",params:{documentId:l.document_id}}):a.push({name:"Chat",params:{documentId:l.threadKey.replace("users:","")}})},w=l=>new Date(l).toLocaleString("pt-BR",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"});return R(()=>{t.userId&&g()}),T(()=>t.userId,l=>{l?(r(l),g()):r("")}),(l,C)=>(h(),A(Q,{"notification-count":0},{default:z(()=>[u("section",Y,[u("header",Z,[C[0]||(C[0]=u("h1",{class:"text-2xl font-semibold"},"Conversas",-1)),f(p)?(h(),x("span",ee,y(f(p))+" não lidas ",1)):I("",!0)]),f(_)?(h(),x("div",te,"Carregando conversas...")):f(v)?(h(),x("div",ae,y(f(v)),1)):I("",!0),u("ul",re,[(h(!0),x(J,null,G(f(c),e=>{var m;return h(),x("li",{key:e.threadKey,class:"flex items-center gap-3 rounded-lg border border-gray-200 dark:border-dark-border bg-white dark:bg-dark-card p-3 shadow-sm cursor-pointer",onClick:i=>n(e)},[u("img",{src:e.other_user_avatar_url||"https://placehold.co/64x64",alt:"Avatar",class:"h-12 w-12 rounded-full object-cover"},null,8,oe),u("div",ne,[u("p",le,y(e.other_user_name||"Contato"),1),u("p",de,y(((m=e.last_message)==null?void 0:m.message)||"Sem mensagens"),1)]),u("div",ie,[u("p",ue,y(e.last_message?w(e.last_message.created_at):""),1),e.unread_count?(h(),x("span",ce,y(e.unread_count),1)):I("",!0)])],8,se)}),128))]),!f(_)&&!f(v)&&f(c).length===0?(h(),A(W,{key:2,title:"Nenhuma conversa",description:"Inicie uma nova conversa a partir de um documento."})):I("",!0)])]),_:1}))}});export{xe as default};
