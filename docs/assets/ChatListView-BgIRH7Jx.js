var D=Object.defineProperty,E=Object.defineProperties;var F=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable;var j=(o,a,t)=>a in o?D(o,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[a]=t,$=(o,a)=>{for(var t in a||(a={}))K.call(a,t)&&j(o,t,a[t]);if(L)for(var t of L(a))N.call(a,t)&&j(o,t,a[t]);return o},S=(o,a)=>E(o,F(a));var M=(o,a,t)=>new Promise((c,_)=>{var p=r=>{try{h(t.next(r))}catch(u){_(u)}},g=r=>{try{h(t.throw(r))}catch(u){_(u)}},h=r=>r.done?c(r.value):Promise.resolve(r.value).then(p,g);h((t=t.apply(o,a)).next())});import{r as b,c as V,a as H,l as R,C as T,p as A,w as z,o as v,h as d,b as x,e as I,i as f,t as y,s as G,F as J,u as O}from"./vue-vendor-D3gglZhg.js";import{s as U,u as P}from"./index-DVvGwCfe.js";import{_ as Q}from"./MainLayout.vue_vue_type_script_setup_true_lang-po6AB_6N.js";import{_ as W}from"./EmptyState.vue_vue_type_script_setup_true_lang-BgLVv4ao.js";import"./supabase-BZLovRLP.js";import"./logofmd-DIbmBIad.js";function X(o){const a=b(o),t=b([]),c=b(!1),_=b(null),p=r=>{a.value=r},g=()=>M(this,null,function*(){var C;if(!a.value)return t.value=[],[];c.value=!0,_.value=null;let r=null,u=null;{const e=yield U.from("chats").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});r=e.data,u=e.error}if(!(r!=null&&r.length)){const e=yield U.from("messages").select("*").or(`sender_id.eq.${a.value},receiver_id.eq.${a.value}`).order("created_at",{ascending:!1});(C=e.data)!=null&&C.length&&(r=e.data,u=e.error)}if(u)return _.value=u.message,c.value=!1,[];const w=new Map()(r!=null?r:[]).forEach(e=>{const m=e.sender_id===a.value?e.receiver_id:e.sender_id,n=e.document_id!==null&&e.document_id!==void 0?`document:${e.document_id}`:`users:${[a.value,m].sort().join("-")}`,s=e.receiver_id===a.value&&!e.read?1:0,l=w.get(n);l?((!l.last_message||e.created_at>l.last_message.created_at)&&(l.last_message=e),l.unread_count+=s):w.set(n,{threadKey:n,document_id:e.document_id,other_user_id:m,last_message:e,unread_count:s})});t.value=Array.from(w.values()).sort((e,m)=>{var n,s,l,k;return((s=(n=m.last_message)==null?void 0:n.created_at)!=null?s:"").localeCompare((k=(l=e.last_message)==null?void 0:l.created_at)!=null?k:"")});const i=[...new Set(t.value.map(e=>e.other_user_id))];if(i.length){const{data:e,error:m}=yield U.from("user_profiles").select("id, avatar_url, full_name").in("id",i);if(!m&&e){const n=new Map(e.map(s=>[s.id,{avatar_url:s.avatar_url,full_name:s.full_name}]));t.value=t.value.map(s=>{var l,k,q,B;return S($({},s),{other_user_avatar_url:(k=(l=n.get(s.other_user_id))==null?void 0:l.avatar_url)!=null?k:null,other_user_name:(B=(q=n.get(s.other_user_id))==null?void 0:q.full_name)!=null?B:"Usuário"})})}else t.value=t.value.map(n=>{var s,l;return S($({},n),{other_user_avatar_url:(s=n.other_user_avatar_url)!=null?s:null,other_user_name:(l=n.other_user_name)!=null?l:"Usuário"})})}return c.value=!1,t.value}),h=V(()=>t.value.reduce((r,u)=>r+u.unread_count,0));return{previews:t,loading:c,error:_,loadChatHistoryList:g,unreadTotal:h,setCurrentUserId:p}}const Y={class:"max-w-3xl mx-auto px-4 py-6 space-y-4"},Z={class:"flex items-center justify-between"},ee={key:0,class:"text-sm text-primary"},te={key:0,class:"text-gray-500"},ae={key:1,class:"text-red-500"},re={class:"space-y-3"},se=["onClick"],oe=["src"],ne={class:"flex-1 overflow-hidden"},le={class:"font-semibold truncate"},ue={class:"text-sm text-gray-600 dark:text-gray-300 truncate"},ie={class:"text-right shrink-0"},de={class:"text-xs text-gray-400"},ce={key:0,class:"ml-auto mt-1 inline-flex min-w-6 justify-center rounded-full bg-primary px-2 py-1 text-xs font-semibold text-white"},xe=H({__name:"ChatListView",setup(o){const a=O(),t=P(),{previews:c,loading:_,error:p,loadChatHistoryList:g,unreadTotal:h,setCurrentUserId:r}=X(t.userId||""),u=i=>{i.document_id?a.push({name:"Chat",params:{documentId:i.document_id}}):a.push({name:"Chat",params:{documentId:i.threadKey.replace("users:","")}})},w=i=>new Date(i).toLocaleString("pt-BR",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"});return R(()=>{t.userId&&g()}),T(()=>t.userId,i=>{i?(r(i),g()):r("")}),(i,C)=>(v(),A(Q,{"notification-count":0},{default:z(()=>[d("section",Y,[d("header",Z,[C[0]||(C[0]=d("h1",{class:"text-2xl font-semibold"},"Conversas",-1)),f(h)?(v(),x("span",ee,y(f(h))+" não lidas ",1)):I("",!0)]),f(_)?(v(),x("div",te,"Carregando conversas...")):f(p)?(v(),x("div",ae,y(f(p)),1)):I("",!0),d("ul",re,[(v(!0),x(J,null,G(f(c),e=>{var m;return v(),x("li",{key:e.threadKey,class:"flex items-center gap-3 rounded-lg border border-gray-200 dark:border-dark-border bg-white dark:bg-dark-card p-3 shadow-sm cursor-pointer",onClick:n=>u(e)},[d("img",{src:e.other_user_avatar_url||"https://placehold.co/64x64",alt:"Avatar",class:"h-12 w-12 rounded-full object-cover"},null,8,oe),d("div",ne,[d("p",le,y(e.other_user_name||"Contato"),1),d("p",ue,y(((m=e.last_message)==null?void 0:m.message)||"Sem mensagens"),1)]),d("div",ie,[d("p",de,y(e.last_message?w(e.last_message.created_at):""),1),e.unread_count?(v(),x("span",ce,y(e.unread_count),1)):I("",!0)])],8,se)}),128))]),!f(_)&&!f(p)&&f(c).length===0?(v(),A(W,{key:2,title:"Nenhuma conversa",description:"Inicie uma nova conversa a partir de um documento."})):I("",!0)])]),_:1}))}});export{xe as default};
