var P=Object.defineProperty,U=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var M=(r,t,e)=>t in r?P(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,q=(r,t)=>{for(var e in t||(t={}))X.call(t,e)&&M(r,e,t[e]);if(I)for(var e of I(t))Y.call(t,e)&&M(r,e,t[e]);return r},N=(r,t)=>U(r,H(t));var b=(r,t,e)=>new Promise((i,u)=>{var h=c=>{try{d(e.next(c))}catch(l){u(l)}},f=c=>{try{d(e.throw(c))}catch(l){u(l)}},d=c=>c.done?i(c.value):Promise.resolve(c.value).then(h,f);d((e=e.apply(r,t)).next())});import{a as Z,P as G,r as g,l as J,X as Q,p as W,w as R,Y as k,u as ee,o as x,h as n,i as E,t as C,b as D,e as te,s as se,n as V,F as ae,O as L,R as re,j as ne,S as oe,Z as ie}from"./vue-vendor-D3gglZhg.js";import{u as ce,a as le,b as de}from"./index-DVvGwCfe.js";import{u as ue}from"./documents-C7yg1LXQ.js";import{s as _}from"./supabase-BWysbwwl.js";import{_ as me}from"./MainLayout.vue_vue_type_script_setup_true_lang-po6AB_6N.js";import"./supabase-BZLovRLP.js";import"./logofmd-DIbmBIad.js";const S={fetchMessages(r,t){return b(this,null,function*(){let e=_.from("chats").select("*").eq("document_id",r).order("created_at",{ascending:!0});t&&(e=e.or(`sender_id.eq.${t},receiver_id.eq.${t}`));const{data:i,error:u}=yield e;if(u)throw u;return i||[]})},sendMessage(r){return b(this,null,function*(){const{data:t,error:e}=yield _.from("chats").insert([N(q({},r),{read:!1})]).select().single();if(e)throw e;return t})},subscribeToDocument(r,t){const e=_.channel(`chats:${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chats",filter:`document_id=eq.${r}`},i=>{t(i.new)}).subscribe();return()=>{_.removeChannel(e)}}},fe={class:"min-h-screen bg-gray-50 dark:bg-dark-bg flex flex-col"},pe={class:"bg-white dark:bg-dark-card border-b border-gray-200 dark:border-dark-border pt-safe px-4 py-3"},he={class:"flex items-center space-x-3"},ve={class:"flex-1"},be={class:"text-sm text-gray-500"},ge={class:"text-sm"},xe={class:"text-xs opacity-70 mt-1"},_e={key:0,class:"text-center py-12"},ye={class:"bg-white dark:bg-dark-card border-t border-gray-200 dark:border-dark-border p-4 pb-safe"},we=["onKeydown"],Me=Z({__name:"ChatView",setup(r){const t=ee(),e=G(),i=ce(),u=ue(),{error:h}=le(),f=e.params.documentId,d=g(""),c=g(null),l=g([]),T=g(!1),y=g("");let v=null;const $=()=>i.userId?!0:(t.push({name:"Login",query:{redirect:e.fullPath}}),!1),j=(o,s)=>{const a=i.userId,m=o.map(p=>p.sender_id===a?p.receiver_id:p.sender_id).find(p=>p&&p!==a);return m||(s&&s!==a?s:"")},A=()=>b(this,null,function*(){var s,a;if(!$())return;T.value=!0;let o="";try{const m=yield u.fetchDocumentById(f);o=((s=m==null?void 0:m.data)==null?void 0:s.user_id)||((a=u.currentDocument)==null?void 0:a.user_id)||"",l.value=yield S.fetchMessages(f,i.userId||void 0),y.value=j(l.value,o)}catch(m){h(m.message||"Erro ao carregar chat")}finally{T.value=!1}yield k(),w(),K()}),K=()=>{v||(v=S.subscribeToDocument(f,o=>{l.value.some(a=>a.id===o.id)||(l.value.push(o),k().then(w))}))},O=o=>`flex ${o===i.userId?"justify-end":"justify-start"}`,z=o=>{const s=o===i.userId,a="max-w-[75%] rounded-2xl px-4 py-2";return s?`${a} bg-primary text-white`:`${a} bg-white dark:bg-dark-card text-gray-900 dark:text-dark-text`},F=o=>new Date(o).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),B=()=>b(this,null,function*(){if(d.value.trim()&&$()){if(!y.value){h("Não foi possível identificar o destinatário.");return}try{const o=yield S.sendMessage({document_id:f,sender_id:i.userId,receiver_id:y.value,message:d.value.trim()});l.value.push(o),d.value="",yield k(),w()}catch(o){h(o.message||"Erro ao enviar mensagem")}}}),w=()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight)};return J(()=>{A()}),Q(()=>{v&&(v(),v=null)}),(o,s)=>(x(),W(me,{"show-top-bar":!1},{default:R(()=>[n("div",fe,[n("header",pe,[n("div",he,[n("button",{class:"btn-icon",onClick:s[0]||(s[0]=a=>E(t).back())},[...s[2]||(s[2]=[n("i",{class:"fas fa-arrow-left"},null,-1)])]),n("div",ve,[s[3]||(s[3]=n("h3",{class:"font-semibold text-gray-900 dark:text-dark-text"},"Chat",-1)),n("p",be,"Documento #"+C(E(f).slice(0,8)),1)])])]),n("div",{class:"flex-1 overflow-y-auto p-4 space-y-4",ref_key:"messagesContainer",ref:c},[(x(!0),D(ae,null,se(l.value,a=>(x(),D("div",{key:a.id,class:V(O(a.sender_id))},[n("div",{class:V(z(a.sender_id))},[n("p",ge,C(a.message),1),n("p",xe,C(F(a.created_at)),1)],2)],2))),128)),l.value.length===0?(x(),D("div",_e,[...s[4]||(s[4]=[n("i",{class:"fas fa-comments text-gray-400 text-6xl mb-4"},null,-1),n("p",{class:"text-gray-500"},"Nenhuma mensagem ainda",-1),n("p",{class:"text-sm text-gray-400"},"Inicie a conversa!",-1)])])):te("",!0)],512),n("div",ye,[n("form",{onSubmit:L(B,["prevent"]),class:"flex items-end space-x-2"},[re(n("textarea",{"onUpdate:modelValue":s[1]||(s[1]=a=>d.value=a),placeholder:"Digite sua mensagem...",class:"input flex-1 min-h-[44px] max-h-32 resize-none",rows:"1",onKeydown:ie(L(B,["exact","prevent"]),["enter"])},null,40,we),[[oe,d.value]]),ne(de,{type:"submit",variant:"primary",disabled:!d.value.trim()},{default:R(()=>[...s[5]||(s[5]=[n("i",{class:"fas fa-paper-plane"},null,-1)])]),_:1},8,["disabled"])],32)])])]),_:1}))}});export{Me as default};
